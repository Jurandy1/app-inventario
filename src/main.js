const state={systemReport:[],inventory:[],liveInventory:[],comparisonResults:{found:[],missingInInventory:[],missingInReport:[]}};document.addEventListener("DOMContentLoaded",()=>{Notiflix.Notify.init({position:"right-bottom",timeout:4e3}),Notiflix.Loading.init({svgColor:"#3B82F6"}),Notiflix.Confirm.init({titleColor:"#3B82F6",okButtonBackground:"#3B82F6"}),function(){document.getElementById("tab-coleta").addEventListener("click",()=>switchTab("coleta")),document.getElementById("tab-gestao").addEventListener("click",()=>switchTab("gestao")),document.getElementById("tab-analise").addEventListener("click",()=>switchTab("analise")),document.getElementById("system-report-input").addEventListener("change",e=>handleFileInput(e,"system")),document.getElementById("inventory-input").addEventListener("change",e=>handleFileInput(e,"inventory")),document.getElementById("live-inventory-form").addEventListener("submit",handleLiveInventorySubmit),document.getElementById("run-comparison").addEventListener("click",runComparison),document.getElementById("export-csv").addEventListener("click",exportResultsToCSV)}(),async function(){Notiflix.Loading.standard("Carregando dados da nuvem...");try{const e=await apiCall({action:"GET_DATA"});e&&e.liveData?(state.liveInventory=e.liveData,renderLiveInventory(),Notiflix.Notify.success("Dados da coleta carregados!")):Notiflix.Notify.info("Nenhum dado de coleta encontrado na nuvem.")}catch(e){console.error("Erro ao carregar dados da coleta:",e),Notiflix.Notify.failure("Falha ao carregar dados da nuvem.")}finally{Notiflix.Loading.remove()}}()});function runComparison(){if(0===state.systemReport.length||0===state.inventory.length)return void Notiflix.Notify.warning("Por favor, carregue o Relatório do Sistema e o Inventário de Campo primeiro.");Notiflix.Loading.standard("Analisando e comparando dados..."),setTimeout(()=>{const e=compareReports(state.systemReport,state.inventory);state.comparisonResults=e,renderComparisonResults(e),document.getElementById("export-csv").classList.remove("hidden"),Notiflix.Loading.remove(),Notiflix.Notify.success("Análise concluída!")},500)}function exportResultsToCSV(){const{found:e,missingInInventory:t,missingInReport:a}=state.comparisonResults;if(0===e.length&&0===t.length&&0===a.length)return void Notiflix.Notify.info("Não há dados para exportar.");Notiflix.Loading.standard("Gerando arquivo CSV...");const s=e.map(e=>({Status:"Encontrado",...e})),i=t.map(e=>({Status:"Falta no Inventário",...e})),n=a.map(e=>({Status:"Sobra no Inventário",...e})),o=Papa.unparse([...s,...i,...n]),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),d=URL.createObjectURL(r);l.setAttribute("href",d),l.setAttribute("download","relatorio_comparativo_inventario.csv"),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),Notiflix.Loading.remove(),Notiflix.Notify.success("Arquivo CSV baixado!")}
