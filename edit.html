<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria e Edi√ß√£o - Sistema de Patrim√¥nio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .table-container { max-height: calc(100vh - 420px); }
        .reconciliation-container { max-height: calc(100vh - 550px); }
        .nav-btn {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #475569;
        }
        .nav-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .saving-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .is-dirty { background-color: #fef9c3 !important; }
        
        #map-system-unit-select, #map-giap-unit-multiselect {
            height: 100%; 
            min-width: 500px;
        }

        .select-container {
            height: 450px;
            overflow: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
        }
        
        .select-container select {
            border: none;
            padding: 0.5rem;
            width: 100%;
        }

        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-container { transition: all 0.3s ease; max-height: 90vh; }
        
        .reconciliation-list-item { cursor: pointer; transition: background-color 0.2s; }
        .reconciliation-list-item:hover { background-color: #eff6ff; }
        .reconciliation-list-item.selected { background-color: #dbeafe; border-left: 4px solid #3b82f6; font-weight: 600; }
        .reconciliation-list-item.selected-for-import { background-color: #e0e7ff; border-left: 4px solid #4f46e5; }
        .reconciliation-list-item.linked { background-color: #dcfce7; color: #166534; pointer-events: none; border-left: 4px solid #22c55e; }
        
        .sub-nav-btn {
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-bottom: 0;
            margin-bottom: -1px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            background-color: #f8fafc;
        }
        .sub-nav-btn.active {
            background-color: white;
            border-color: #e2e8f0;
            color: #3b82f6;
        }

        .notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.4s ease-in-out;
            z-index: 1000;
        }
        .notification-toast.show { transform: translateX(-50%) translateY(0); }
        .notification-toast.success { background-color: #10b981; }
        .notification-toast.error { background-color: #ef4444; }
        .notification-toast.info { background-color: #3b82f6; }
        .notification-toast.warning { background-color: #f59e0b; }
        .created-link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-link-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
        }
        .delete-link-btn:hover {
            background-color: #fee2e2;
        }
    </style>
</head>
<body class="text-slate-700 antialiased">
    <div id="auth-gate" class="hidden">

        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto p-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">Auditoria e Edi√ß√£o do Invent√°rio</h1>
                        <p id="feedback-status" class="text-sm font-semibold text-slate-600">Pronto para come√ßar.</p>
                    </div>
                    <button id="force-refresh-btn" title="For√ßar Atualiza√ß√£o dos Dados" class="p-2 rounded-md hover:bg-slate-100 text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                    </button>
                </div>
                <div id="user-info-edit" class="text-right">
                    <p id="user-email-edit" class="font-semibold"></p>
                    <p class="text-xs text-green-600 font-bold">Modo de Edi√ß√£o Ativado</p>
                    <button id="logout-btn" class="text-sm text-red-600 hover:underline">Sair</button>
                </div>
            </div>
        </header>
        
        <!-- Navega√ß√£o por Abas -->
        <nav class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky z-40 top-[88px]">
            <div class="container mx-auto px-4">
                <div id="edit-nav" class="flex space-x-1 overflow-x-auto">
                    <button class="nav-btn active" data-tab="edicao">‚úèÔ∏è Invent√°rio Edit√°vel</button>
                    <button class="nav-btn" data-tab="unidades">üîó Ligar Unidades</button>
                    <button class="nav-btn" data-tab="conciliar">ü§ù Conciliar Itens</button>
                    <button class="nav-btn" data-tab="sobrando">‚ö†Ô∏è Tombos Sobrando</button>
                    <button class="nav-btn" data-tab="transferencias">üö® Transfer√™ncias</button>
                    <button class="nav-btn" data-tab="importacao">üîÑ Importa√ß√£o e Substitui√ß√£o</button>
                    <button class="nav-btn" data-tab="notas_fiscais">üìã Notas Fiscais</button>
                    <button class="nav-btn" data-tab="giap">üìã Planilha GIAP</button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-4">
            
            <!-- ABA: Invent√°rio Edit√°vel -->
            <div id="content-edicao" class="fade-in">
                 <div class="card">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="edit-filter-tipo" class="block text-sm font-medium mb-1">Filtrar por Tipo</label>
                            <select id="edit-filter-tipo" class="w-full p-2 border rounded-lg bg-white"></select>
                        </div>
                        <div>
                            <label for="edit-filter-unidade" class="block text-sm font-medium mb-1">Filtrar por Unidade</label>
                            <select id="edit-filter-unidade" class="w-full p-2 border rounded-lg bg-white"></select>
                             <div class="flex justify-between items-center mt-1">
                                <p id="unit-item-count" class="text-sm font-semibold text-slate-600"></p>
                                <button type="button" id="add-item-to-unit-btn" class="hidden text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200">
                                    + Adicionar Item
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="edit-filter-estado" class="block text-sm font-medium mb-1">Filtrar por Estado</label>
                            <select id="edit-filter-estado" class="w-full p-2 border rounded-lg bg-white"></select>
                        </div>
                        <div>
                            <label for="edit-filter-descricao" class="block text-sm font-medium mb-1">Buscar por Descri√ß√£o</label>
                            <input type="text" id="edit-filter-descricao" class="w-full p-2 border rounded-lg" placeholder="Digite para buscar...">
                        </div>
                    </div>
                    <button id="save-all-changes-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-slate-400 flex items-center gap-2" disabled>
                        <span id="save-btn-spinner" class="hidden saving-spinner"></span>
                        <span id="save-btn-text">Salvar Altera√ß√µes</span>
                    </button>
                </div>
                <div class="card mt-6 p-0 overflow-hidden">
                    <div class="table-container overflow-y-auto">
                        <table class="w-full text-sm min-w-[1900px]">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left font-semibold">A√ß√µes</th>
                                    <th class="p-3 text-left font-semibold">Tombamento</th>
                                    <th class="p-3 text-left font-semibold">Descri√ß√£o</th>
                                    <th class="p-3 text-left font-semibold">Tipo</th>
                                    <th class="p-3 text-left font-semibold">Unidade</th>
                                    <th class="p-3 text-left font-semibold">Localiza√ß√£o</th>
                                    <th class="p-3 text-left font-semibold">Fornecedor</th>
                                    <th class="p-3 text-left font-semibold">NF</th>
                                    <th class="p-3 text-left font-semibold">Origem da Doa√ß√£o</th>
                                    <th class="p-3 text-left font-semibold">Estado</th>
                                    <th class="p-3 text-left font-semibold">Quantidade</th>
                                    <th class="p-3 text-left font-semibold">Observa√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="edit-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ABA: Ligar Unidades -->
            <div id="content-unidades" class="hidden fade-in">
                <div class="card">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Mapeamento de Unidades</h2>
                    <p class="text-sm text-slate-600 mb-4">Ligue uma ou mais 'Unidades do Sistema' a uma ou mais 'Unidades da Planilha'. Use Ctrl/Shift+Click para m√∫ltiplas sele√ß√µes.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="map-filter-tipo" class="block text-sm font-medium mb-1">Filtrar por Tipo (Sistema)</label>
                            <select id="map-filter-tipo" class="w-full p-2 border rounded-lg bg-white mb-4"></select>
                            <label for="map-system-unit-select" class="block text-sm font-medium mb-1">Unidade(s) do Sistema</label>
                            <div class="select-container">
                                <select id="map-system-unit-select" multiple></select>
                            </div>
                        </div>
                        <div>
                             <label for="map-giap-unit-multiselect" class="block text-sm font-medium mb-1">Unidade(s) da Planilha GIAP</label>
                             <input type="text" id="map-giap-filter" class="w-full p-2 border rounded-lg my-2" placeholder="Pesquisar unidade da planilha...">
                            <div class="select-container">
                                <select id="map-giap-unit-multiselect" multiple></select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="save-mapping-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Salvar Liga√ß√£o</button>
                    </div>
                    <div class="mt-6 border-t pt-4">
                        <h3 class="font-bold text-slate-700 mb-2">Liga√ß√µes Salvas</h3>
                        <div id="saved-mappings-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
            
            <!-- ABA: Conciliar Itens -->
            <div id="content-conciliar" class="hidden fade-in">
                <div class="card">
                    <div class="flex border-b mb-6">
                        <button class="sub-nav-btn active" data-subtab-conciliar="conciliacao_main">Concilia√ß√£o</button>
                        <button class="sub-nav-btn" data-subtab-conciliar="itens_a_tombar">Itens S/T a Tombar</button>
                    </div>
                    
                    <div id="subtab-conciliar-conciliacao_main">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">ü§ù Conciliar Itens</h2>
                        <p class="text-sm text-slate-600 mb-4">Filtre por tipo e unidade, carregue os dados e depois clique em um item de cada lista para criar um v√≠nculo. O sistema ir√° sugerir os melhores tombos para o item selecionado.</p>
                        <div class="flex flex-wrap items-end gap-2 mb-4">
                            <div class="flex-grow">
                                <label for="filter-tipo" class="text-sm font-medium">Tipo</label>
                                <select id="filter-tipo" class="w-full border p-2 rounded-lg mt-1">
                                    <option value="">Todos os Tipos</option>
                                </select>
                            </div>
                            <div class="flex-grow">
                                <label for="filter-unidade" class="text-sm font-medium">Unidade</label>
                                <select id="filter-unidade" class="w-full border p-2 rounded-lg mt-1">
                                    <option value="">Selecione o Tipo Primeiro</option>
                                </select>
                            </div>
                            <button id="load-conciliar" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Carregar
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-slate-800 mb-2">Itens sem Tombamento no Sistema</h3>
                                <input type="text" id="system-list-filter" class="w-full p-2 border rounded-lg mb-2" placeholder="Filtrar por descri√ß√£o...">
                                <div id="system-list" class="reconciliation-container border p-2 space-y-2 rounded-lg bg-slate-50 overflow-y-auto"></div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-800 mb-2">Tombos Dispon√≠veis (GIAP)</h3>
                                <input type="text" id="giap-list-filter" class="w-full p-2 border rounded-lg mb-2" placeholder="Filtrar por descri√ß√£o...">
                                <div id="giap-list" class="reconciliation-container border p-2 space-y-2 rounded-lg bg-slate-50 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div id="quick-actions" class="mt-6 border-t pt-4 hidden">
                            <h3 class="font-semibold text-slate-800 mb-2">V√≠nculos Criados</h3>
                            <div id="created-links" class="space-y-2 mb-4"></div>
                            <div class="flex items-center gap-2">
                                <button id="save-links" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar V√≠nculos</button>
                                <button id="clear-selections" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Limpar Sele√ß√µes</button>
                            </div>
                        </div>
                        <!-- Se√ß√£o de Importa√ß√£o GIAP -->
                        <div id="giap-import-section" class="mt-6 border-t pt-4">
                            <h3 class="font-semibold text-slate-800 mb-2">üì• Importar Tombos do GIAP para esta Unidade</h3>
                            <p class="text-sm text-slate-600 mb-4">Selecione um ou mais itens da lista "Tombos Dispon√≠veis" (sem selecionar um item da lista √† esquerda) para import√°-los diretamente.</p>
                            <div class="flex items-end gap-4">
                                <div>
                                    <label for="import-estado-select" class="block text-sm font-medium mb-1">Estado dos Itens a Importar</label>
                                    <select id="import-estado-select" class="w-full p-2 border rounded-lg bg-white">
                                        <option>Novo</option>
                                        <option>Bom</option>
                                        <option>Regular</option>
                                        <option>Avariado</option>
                                    </select>
                                </div>
                                <button id="import-giap-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:bg-slate-400" disabled>Importar <span id="giap-import-count">0</span> Selecionados</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="subtab-conciliar-itens_a_tombar" class="hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Itens S/T com Novo Tombo (Aguardando Etiqueta)</h2>
                        <p class="text-sm text-slate-600 mb-4">Esta √© uma lista de controle de itens que eram S/T e foram conciliados. Ap√≥s aplicar a etiqueta f√≠sica com o novo n√∫mero de tombo, confirme para remover o item da lista.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div>
                                <label for="tombar-filter-tipo" class="block text-sm font-medium mb-1">Filtrar por Tipo</label>
                                <select id="tombar-filter-tipo" class="w-full p-2 border rounded-lg bg-white"></select>
                            </div>
                            <div>
                                <label for="tombar-filter-unidade" class="block text-sm font-medium mb-1">Filtrar por Unidade</label>
                                <select id="tombar-filter-unidade" class="w-full p-2 border rounded-lg bg-white" disabled></select>
                            </div>
                        </div>
                        <div id="itens-a-tombar-container" class="mt-4"></div>
                    </div>
                </div>
            </div>


            <!-- ABA: Tombos Sobrando -->
            <div id="content-sobrando" class="hidden fade-in">
                <div class="card">
                     <h2 class="text-xl font-bold text-slate-800 mb-2">Tombamentos da Planilha Sem V√≠nculo</h2>
                     <p class="text-sm text-slate-600 mb-4">Tombamentos da planilha que ainda n√£o foram associados a nenhum item. Use os filtros para encontrar poss√≠veis correspond√™ncias.</p>
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                          <label for="leftover-keyword" class="block text-sm font-medium mb-1">Buscar por Descri√ß√£o</label>
                          <input type="text" id="leftover-keyword" class="w-full p-2 border rounded-lg" placeholder="Ex: Cadeira, mesa...">
                        </div>
                        <div>
                          <label for="leftover-tombo" class="block text-sm font-medium mb-1">Filtrar por Tombamento</label>
                          <input type="text" id="leftover-tombo" class="w-full p-2 border rounded-lg" placeholder="Ex: 14023...">
                        </div>
                        <div class="self-end">
                          <button id="suggest-sobrando" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Buscar Sobrando</button>
                        </div>
                      </div>
                     <div class="mt-4 border-t pt-4">
                        <h3 class="font-bold">Resultados (<span id="total-sobrando">0</span>)</h3>
                        <div id="sobrando-list" class="reconciliation-container overflow-y-auto space-y-2 mt-2"></div>
                     </div>
                </div>
            </div>

            <!-- ABA: Transfer√™ncias -->
            <div id="content-transferencias" class="hidden fade-in">
                <div class="card">
                     <h2 class="text-xl font-bold text-slate-800 mb-2">Transfer√™ncias Pendentes</h2>
                     <p class="text-sm text-slate-600 mb-4">Itens agrupados por unidade de origem. Clique em uma unidade para expandir e ver os itens que precisam ser transferidos.</p>
                     <div id="pending-transfers-container" class="mt-4 space-y-2"></div>
                </div>
            </div>
            
            <!-- ABA: Importa√ß√£o e Substitui√ß√£o -->
            <div id="content-importacao" class="hidden fade-in">
                <div class="card">
                    <div class="flex border-b mb-6">
                        <button class="sub-nav-btn active" data-subtab="substituir">Substituir Invent√°rio</button>
                        <button class="sub-nav-btn" data-subtab="edit-by-desc">Editar por Descri√ß√£o</button> <!-- NOVA FERRAMENTA -->
                        <button class="sub-nav-btn" data-subtab="massa">Importar por Tombamento</button>
                        <button class="sub-nav-btn" data-subtab="add_giap">Adicionar Unidade GIAP</button>
                    </div>
            
                    <!-- Sub-Aba: Substituir Invent√°rio -->
                    <div id="subtab-content-substituir">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Substituir Invent√°rio da Unidade por Planilha</h2>
                        <p class="text-sm text-slate-600 mb-4">Esta ferramenta <strong class="text-red-600">APAGAR√Å</strong> todos os itens da unidade selecionada e os substituir√° pelos dados colados abaixo. Use com muito cuidado.</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="replace-tipo" class="block text-sm font-medium mb-1">Tipo de Unidade de Destino</label>
                                <select id="replace-tipo" class="w-full p-2 border rounded-lg bg-white"></select>
                            </div>
                            <div>
                                <label for="replace-unit" class="block text-sm font-medium mb-1">Unidade de Destino (a ser substitu√≠da)</label>
                                <select id="replace-unit" class="w-full p-2 border rounded-lg bg-white" disabled></select>
                            </div>
                        </div>

                        <div>
                            <label for="replace-data" class="block text-sm font-medium mb-1">Cole os dados do Excel aqui</label>
                            <p class="text-xs text-slate-500 mb-2">As colunas devem estar na ordem: UNIDADE, ITEM, TOMBO, LOCAL, ESTADO DE CONSERVA√á√ÉO</p>
                            <textarea id="replace-data" rows="8" class="w-full p-2 border rounded-lg font-mono text-xs" placeholder="Copie as colunas do Excel e cole aqui..."></textarea>
                        </div>
                        <button id="preview-replace-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Visualizar Dados</button>

                        <div id="replace-results" class="hidden mt-6 border-t pt-4">
                            <h3 class="font-bold text-slate-700 mb-2">Pr√©-visualiza√ß√£o dos Itens a Serem Criados (<span id="replace-preview-count">0</span>)</h3>
                            <div id="replace-preview-list" class="reconciliation-container overflow-y-auto space-y-2 p-2 bg-slate-50 border rounded-lg"></div>
                            <div class="mt-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                                <div class="flex items-start">
                                    <input type="checkbox" id="replace-confirm-checkbox" class="mt-1 h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                    <label for="replace-confirm-checkbox" class="ml-3 block text-sm font-medium text-red-800">
                                        Eu entendo que <strong class="font-bold">TODOS OS ITENS</strong> da unidade selecionada ser√£o <strong class="font-bold">PERMANENTEMENTE APAGADOS</strong> e substitu√≠dos por esta nova lista.
                                    </label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button id="confirm-replace-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 disabled:bg-slate-400" disabled>Confirmar e Substituir Invent√°rio</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- IN√çCIO: Nova Sub-Aba: Editar por Descri√ß√£o -->
                    <div id="subtab-content-edit-by-desc" class="hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Editar Tombamentos por Descri√ß√£o (com L√≥gica Aprimorada)</h2>
                        <p class="text-sm text-slate-600 mb-4">
                            Esta ferramenta inteligente atualiza itens existentes em uma unidade. Ela localiza os itens por <strong class="text-blue-600">Descri√ß√£o similar</strong> e outros campos, depois atualiza Tombamento, Localiza√ß√£o e Estado.
                        </p>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="edit-by-desc-tipo" class="block text-sm font-medium mb-1">Tipo de Unidade de Destino</label>
                                <select id="edit-by-desc-tipo" class="w-full p-2 border rounded-lg bg-white"></select>
                            </div>
                            <div>
                                <label for="edit-by-desc-unit" class="block text-sm font-medium mb-1">Unidade de Destino (a ser atualizada)</label>
                                <select id="edit-by-desc-unit" class="w-full p-2 border rounded-lg bg-white" disabled></select>
                            </div>
                        </div>

                        <div>
                            <label for="edit-by-desc-data" class="block text-sm font-medium mb-1">Cole os dados do Excel aqui (com cabe√ßalho)</label>
                            <p class="text-xs text-slate-500 mb-2">
                                O sistema identificar√° as colunas pelos cabe√ßalhos: <strong>ITEM (ou Descri√ß√£o)</strong>, <strong>TOMBO (ou Tombamento)</strong>, <strong>LOCAL (ou Localiza√ß√£o)</strong>, <strong>ESTADO DE CONSERVA√á√ÉO (ou Estado)</strong>.
                            </p>
                            <textarea id="edit-by-desc-data" rows="8" class="w-full p-2 border rounded-lg font-mono text-xs" placeholder="Copie as colunas do Excel, incluindo o cabe√ßalho, e cole aqui..."></textarea>
                        </div>
                        <button id="preview-edit-by-desc-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Visualizar Dados para Atualiza√ß√£o</button>

                        <div id="edit-by-desc-results" class="hidden mt-6 border-t pt-4">
                             <h3 class="font-bold text-slate-700 mb-2">Pr√©-visualiza√ß√£o das Atualiza√ß√µes (<span id="edit-by-desc-preview-count">0</span> itens)</h3>
                             <p class="text-sm text-slate-600 mb-4">Revise as altera√ß√µes. Itens em <span class="text-yellow-600 font-semibold">amarelo</span> n√£o foram encontrados ou a correspond√™ncia √© amb√≠gua. Itens em <span class="text-red-600 font-semibold">vermelho</span> possuem um tombamento que j√° est√° em uso por outro item.</p>
                            <div id="edit-by-desc-preview-table-container" class="reconciliation-container overflow-y-auto space-y-2 p-2 bg-slate-50 border rounded-lg">
                                <!-- A tabela de pr√©-visualiza√ß√£o ser√° inserida aqui -->
                            </div>
                             <div class="mt-4">
                                <button id="confirm-edit-by-desc-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:bg-slate-400">Confirmar e Atualizar Itens</button>
                            </div>
                        </div>
                    </div>
                    <!-- FIM: Nova Sub-Aba -->

                    <!-- Sub-Aba: Importar em Massa (funcionalidade antiga) -->
                    <div id="subtab-content-massa" class="hidden">
                         <h2 class="text-xl font-bold text-slate-800 mb-2">Importar Itens por Tombamento (GIAP)</h2>
                         <p class="text-sm text-slate-600 mb-4">Cole uma lista de tombamentos, escolha a unidade de destino e o sistema criar√° os itens baseado nos dados da planilha GIAP.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="mass-transfer-tombos" class="block text-sm font-medium mb-1">N√∫meros de Tombamento (separados por v√≠rgula)</label>
                                <textarea id="mass-transfer-tombos" rows="4" class="w-full p-2 border rounded-lg" placeholder="140230, 14233, 12345..."></textarea>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="mass-transfer-tipo" class="block text-sm font-medium mb-1">Tipo de Unidade de Destino</label>
                                    <select id="mass-transfer-tipo" class="w-full p-2 border rounded-lg bg-white"></select>
                                </div>
                                <div>
                                    <label for="mass-transfer-unit" class="block text-sm font-medium mb-1">Unidade de Destino</label>
                                    <select id="mass-transfer-unit" class="w-full p-2 border rounded-lg bg-white" disabled></select>
                                </div>
                            </div>
                            <button id="mass-transfer-search-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Buscar Tombamentos</button>
                        </div>
                        <div id="mass-transfer-results" class="hidden mt-6 border-t pt-4">
                            <h3 class="font-bold text-slate-700 mb-2">Itens a serem criados</h3>
                            <div class="flex items-center gap-4 mb-4">
                                 <label for="mass-transfer-set-all-status" class="block text-sm font-medium">Definir Estado para Todos:</label>
                                 <select id="mass-transfer-set-all-status" class="p-2 border rounded-lg bg-white">
                                    <option>Novo</option>
                                    <option>Bom</option>
                                    <option>Regular</option>
                                    <option>Avariado</option>
                                 </select>
                            </div>
                            <div id="mass-transfer-list" class="space-y-2"></div>
                            <div class="mt-6">
                                <button id="mass-transfer-confirm-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Confirmar Cria√ß√£o em Massa</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-Aba: Adicionar Unidade GIAP -->
                     <div id="subtab-content-add_giap" class="hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Adicionar Nova Unidade (Padr√£o GIAP)</h2>
                        <p class="text-sm text-slate-600 mb-4">Adicione aqui uma nova unidade que ainda n√£o existe na planilha GIAP. Ela ficar√° dispon√≠vel na aba "Ligar Unidades".</p>
                        <div class="space-y-4 max-w-md">
                            <div>
                                <label for="add-giap-number" class="block text-sm font-medium mb-1">N√∫mero da Unidade (opcional)</label>
                                <input type="text" id="add-giap-number" class="w-full p-2 border rounded-lg" placeholder="Ex: 140.3">
                            </div>
                            <div>
                                <label for="add-giap-name" class="block text-sm font-medium mb-1">Nome da Nova Unidade</label>
                                <input type="text" id="add-giap-name" class="w-full p-2 border rounded-lg" placeholder="Ex: CRAS VILA ESPERAN√áA (NOVO)" required>
                            </div>
                            <button id="save-giap-unit-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Salvar Nova Unidade</button>
                        </div>
                     </div>
                </div>
            </div>

            <!-- ABA: Notas Fiscais -->
            <div id="content-notas_fiscais" class="hidden fade-in">
                <div class="card">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">üìã Notas Fiscais</h2>
                    <p class="text-sm text-slate-600 mb-4">Lista de notas fiscais da Planilha GIAP, agrupadas por categoria. Verifique quais itens j√° foram alocados no invent√°rio.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 pb-4 border-b">
                        <div>
                            <label for="nf-search" class="block text-sm font-medium mb-1">Pesquisar por N¬∫ da NF</label>
                            <input type="text" id="nf-search" placeholder="Digite o n√∫mero..." class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="nf-item-search" class="block text-sm font-medium mb-1">Pesquisar por Item</label>
                            <input type="text" id="nf-item-search" placeholder="Digite o nome do item..." class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="nf-tipo-entrada" class="block text-sm font-medium mb-1">Tipo de Entrada</label>
                            <select id="nf-tipo-entrada" class="w-full p-2 border rounded-lg bg-white">
                                <option value="">Todas</option>
                                <option value="Compra">Compra</option>
                                <option value="Doa√ß√£o">Doa√ß√£o</option>
                            </select>
                        </div>
                        <div class="self-end">
                            <button id="clear-nf-filters-btn" class="w-full bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300">Limpar Filtros</button>
                        </div>
                        <div>
                            <label for="nf-date-start" class="block text-sm font-medium mb-1">Data de In√≠cio (Cadastro)</label>
                            <input type="date" id="nf-date-start" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="nf-date-end" class="block text-sm font-medium mb-1">Data de Fim (Cadastro)</label>
                            <input type="date" id="nf-date-end" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>

                    <div id="notas-fiscais-container" class="mt-4"></div>
                </div>
            </div>


            <!-- ABA: Planilha GIAP -->
            <div id="content-giap" class="hidden fade-in">
                <div class="card p-0 overflow-hidden">
                    <div class="table-container overflow-y-auto">
                        <table class="w-full text-sm min-w-[1800px]">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left font-semibold">TOMBAMENTO</th>
                                    <th class="p-3 text-left font-semibold">Descri√ß√£o</th>
                                    <th class="p-3 text-left font-semibold">Cadastro</th>
                                    <th class="p-3 text-left font-semibold">NF</th>
                                    <th class="p-3 text-left font-semibold">Nome Fornecedor</th>
                                    <th class="p-3 text-left font-semibold">Tipo Entrada</th>
                                    <th class="p-3 text-left font-semibold">Unidade</th>
                                    <th class="p-3 text-left font-semibold">Valor NF</th>
                                    <th class="p-3 text-left font-semibold">Esp√©cie</th>
                                </tr>
                            </thead>
                            <tbody id="giap-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="sync-confirm-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60"></div>
        <div class="modal-container bg-white w-full max-w-lg rounded-lg shadow-2xl flex flex-col transform scale-95">
             <div class="p-4 border-b">
                <h3 class="text-xl font-semibold">Confirmar Sincroniza√ß√£o</h3>
             </div>
             <div class="p-6 space-y-4">
                <p>O item <strong id="sync-item-tombo" class="font-mono"></strong> foi encontrado na planilha GIAP. Deseja atualizar a descri√ß√£o?</p>
                <div>
                    <p class="text-sm font-medium text-gray-500">Descri√ß√£o Atual no Sistema:</p>
                    <p id="sync-current-desc" class="p-2 bg-gray-100 rounded-md text-sm"></p>
                </div>
                 <div>
                    <p class="text-sm font-medium text-green-700">Nova Descri√ß√£o da Planilha:</p>
                    <p id="sync-new-desc" class="p-2 bg-green-50 rounded-md text-sm font-semibold"></p>
                </div>
                <p class="text-sm text-slate-600">Os campos "Fornecedor" e "NF" ser√£o atualizados em ambos os casos.</p>
             </div>
             <div class="flex justify-end p-4 border-t bg-slate-50 rounded-b-lg space-x-2">
                <button type="button" id="sync-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" id="sync-keep-desc-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Manter Descri√ß√£o Atual</button>
                <button type="button" id="sync-update-all-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Sim, Atualizar Tudo</button>
             </div>
        </div>
    </div>

    <div id="add-item-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60"></div>
        <div class="modal-container bg-white w-full max-w-lg rounded-lg shadow-2xl flex flex-col transform scale-95">
            <form id="add-item-form">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 id="add-modal-title" class="text-xl font-semibold">Adicionar Novo Item</h3>
                    <button type="button" class="p-2 rounded-full hover:bg-slate-200 js-close-modal-add">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="add-item-unidade" class="block text-sm font-medium mb-1">Unidade</label>
                        <input type="text" id="add-item-unidade" class="w-full p-2 border rounded-lg bg-slate-100" readonly>
                    </div>
                    <div>
                        <label for="add-item-tipo" class="block text-sm font-medium mb-1">Tipo</label>
                        <input type="text" id="add-item-tipo" class="w-full p-2 border rounded-lg bg-slate-100" readonly>
                    </div>
                    <hr>
                    <div>
                        <label for="add-item-tombamento" class="block text-sm font-medium mb-1">Tombamento</label>
                        <input type="text" id="add-item-tombamento" class="w-full p-2 border rounded-lg" placeholder="N¬∫ de tombamento ou S/T">
                    </div>
                    <div>
                        <label for="add-item-descricao" class="block text-sm font-medium mb-1">Descri√ß√£o</label>
                        <input type="text" id="add-item-descricao" class="w-full p-2 border rounded-lg" placeholder="Ex: Cadeira girat√≥ria" required>
                    </div>
                    <div>
                        <label for="add-item-estado" class="block text-sm font-medium mb-1">Estado de Conserva√ß√£o</label>
                        <select id="add-item-estado" class="w-full p-2 border rounded-lg bg-white" required>
                            <option>Novo</option>
                            <option>Bom</option>
                            <option>Regular</option>
                            <option>Avariado</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end p-4 border-t bg-slate-50 rounded-b-lg space-x-2">
                    <button type="button" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 js-close-modal-add">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DE ESCOLHA DE DESCRI√á√ÉO - NOVO -->
    <div id="desc-choice-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay absolute inset-0 bg-black/60"></div>
        <div class="modal-container bg-white w-full max-w-lg rounded-lg shadow-2xl flex flex-col transform scale-95">
             <div class="p-4 border-b">
                <h3 class="text-xl font-semibold">Escolha a Descri√ß√£o do Item</h3>
             </div>
             <div class="p-6 space-y-4">
                <p>Qual descri√ß√£o voc√™ prefere para o item <strong id="desc-choice-tombo" class="font-mono"></strong>?</p>
                <div>
                    <p class="text-sm font-medium text-gray-500">Descri√ß√£o Atual no Sistema:</p>
                    <p id="desc-choice-current" class="p-2 bg-gray-100 rounded-md text-sm"></p>
                </div>
                 <div>
                    <p class="text-sm font-medium text-blue-700">Nova Descri√ß√£o da Planilha GIAP:</p>
                    <p id="desc-choice-new" class="p-2 bg-blue-50 rounded-md text-sm font-semibold"></p>
                </div>
             </div>
             <div class="flex justify-end p-4 border-t bg-slate-50 rounded-b-lg space-x-2">
                <button type="button" id="desc-choice-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" id="desc-choice-keep-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Manter Descri√ß√£o Atual</button>
                <button type="button" id="desc-choice-update-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Usar Descri√ß√£o da Planilha</button>
             </div>
        </div>
    </div>
    
    <!-- Full Page Overlay for saving -->
    <div id="full-page-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/50">
        <div class="text-center text-white">
            <div class="w-16 h-16 border-8 border-dashed rounded-full animate-spin border-white mx-auto"></div>
            <p id="overlay-message" class="mt-4 text-lg font-semibold">Salvando... Recarregando...</p>
        </div>
    </div>

    <div id="loading-or-error-screen" class="flex items-center justify-center h-screen">
        <div class="text-center"><div class="w-16 h-16 border-8 border-dashed rounded-full animate-spin border-blue-600 mx-auto"></div><p class="mt-4 text-slate-600">Carregando e analisando dados...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-guQcwkWpMOBdQhdgeeLcwHaDPT7NxJUd0qQSDveG3Xa2F3zx-ygkpakW-fpwAzSx1Q/exec';

        const firebaseConfig = {
            apiKey: "AIzaSyBq9vMW39Cba8fqgXfRNtxqOltnTiaKjnU",
            authDomain: "controle-de-patrimonio-semcas.firebaseapp.com",
            projectId: "controle-de-patrimonio-semcas",
            storageBucket: "controle-de-patrimonio-semcas.firebasestorage.app",
            messagingSenderId: "438620819929",
            appId: "1:438620819929:web:6fcbc12905a0c928e549c8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        let fullInventory = [], giapInventory = [], customGiapUnits = [];
        let giapMap = new Map();
        let unitMapping = {};
        let dirtyItems = new Map();
        let normalizedSystemUnits = new Map();
        let padroesConciliacao = []; // IA LEARNING
        let linksToCreate = []; // Armazena v√≠nculos pendentes
        let dataCache = null; // Cache de sess√£o
        
        let selSys = null, selGiap = null;
        let giapItemsForImport = [];
        let itemsToReplace = [];
        let processedNfData = {}; // To store processed NF data
        let updatesToProcess = []; // For the new "Edit by Desc" tool

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-or-error-screen');
        const authGate = document.getElementById('auth-gate');
        const feedbackStatus = document.getElementById('feedback-status');
        const forceRefreshBtn = document.getElementById('force-refresh-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const navButtons = document.querySelectorAll('#edit-nav .nav-btn');
        const contentPanes = document.querySelectorAll('main > div[id^="content-"]');
        
        const editTableBody = document.getElementById('edit-table-body');
        const saveAllChangesBtn = document.getElementById('save-all-changes-btn');
        const editFilterTipo = document.getElementById('edit-filter-tipo');
        const editFilterUnidade = document.getElementById('edit-filter-unidade');
        const editFilterEstado = document.getElementById('edit-filter-estado');
        const editFilterDescricao = document.getElementById('edit-filter-descricao');
        const mapFilterTipo = document.getElementById('map-filter-tipo');
        const mapSystemUnitSelect = document.getElementById('map-system-unit-select');
        const mapGiapUnitMultiselect = document.getElementById('map-giap-unit-multiselect');
        const mapGiapFilter = document.getElementById('map-giap-filter');
        const saveMappingBtn = document.getElementById('save-mapping-btn');
        const savedMappingsContainer = document.getElementById('saved-mappings-container');
        const pendingTransfersContainer = document.getElementById('pending-transfers-container');
        const giapTableBody = document.getElementById('giap-table-body');
        const fullPageOverlay = document.getElementById('full-page-overlay');
        const overlayMessage = document.getElementById('overlay-message');

        const syncConfirmModal = document.getElementById('sync-confirm-modal');
        const syncUpdateAllBtn = document.getElementById('sync-update-all-btn');
        const syncKeepDescBtn = document.getElementById('sync-keep-desc-btn');
        const syncCancelBtn = document.getElementById('sync-cancel-btn');

        const descChoiceModal = document.getElementById('desc-choice-modal');


        // --- Fun√ß√µes Utilit√°rias ---
        const normalizeStr = (str) => (str || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase();
        const debounce = (func, delay) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>func.apply(this,a),delay);}};
        const escapeHtml = (unsafe) => (unsafe === undefined || unsafe === null) ? '' : unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        
        function levenshteinDistance(s1, s2) {
            const len1 = s1.length; const len2 = s2.length;
            if (Math.abs(len1 - len2) > 20) return Math.max(len1, len2);
            const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(0));
            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;
            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + cost);
                }
            }
            return matrix[len2][len1];
        }

        function calculateSimilarity(str1, str2) {
            const s1 = normalizeStr(str1); const s2 = normalizeStr(str2);
            if (s1 === s2) return 1.0;
            if (s1.includes(s2) || s2.includes(s1)) return 0.92;
            const words1 = new Set(s1.split(/\s+/).filter(w => w.length > 2)); const words2 = new Set(s2.split(/\s+/).filter(w => w.length > 2));
            if (words1.size === 0 && words2.size === 0) return 0;
            const intersection = new Set([...words1].filter(w => words2.has(w))); const union = new Set([...words1, ...words2]);
            const jaccardScore = union.size > 0 ? intersection.size / union.size : 0;
            let substringBonus = 0; const minLen = Math.min(s1.length, s2.length);
            for (let size = Math.min(8, minLen); size >= 4; size--) {
                let found = false;
                for (let i = 0; i <= s1.length - size; i++) {
                    const substr = s1.substring(i, i + size);
                    if (s2.includes(substr)) { substringBonus = Math.max(substringBonus, (size / Math.max(s1.length, s2.length)) * 0.3); found = true; break; }
                }
                if (found) break;
            }
            let levBonus = 0;
            if (s1.length < 50 && s2.length < 50) {
                const distance = levenshteinDistance(s1, s2); const maxLen = Math.max(s1.length, s2.length);
                levBonus = maxLen > 0 ? (1 - distance / maxLen) * 0.2 : 0;
            }
            return Math.min(jaccardScore * 0.6 + substringBonus + levBonus, 1.0);
        }

        function suggestGiapMatchesComAprendizado(systemItem) {
            let { giapItems } = getConciliationData();
            if (!giapItems || giapItems.length === 0) { renderList('giap-list', [], 'TOMBAMENTO', 'Descri√ß√£o'); return; }
            const systemDesc = `${systemItem.Descri√ß√£o || ''} ${systemItem.Fornecedor || ''}`.trim();
            const scoredItems = giapItems.map(giapItem => {
                const giapDesc = `${giapItem.Descri√ß√£o || ''} ${giapItem.Esp√©cie || ''} ${giapItem['Nome Fornecedor'] || ''}`.trim();
                let baseScore = calculateSimilarity(systemDesc, giapDesc);
                if (systemItem.Fornecedor && systemItem.Fornecedor !== '-' && giapItem['Nome Fornecedor'] && giapItem['Nome Fornecedor'] !== '-') {
                    const fornecedorMatch = calculateSimilarity(systemItem.Fornecedor, giapItem['Nome Fornecedor']);
                    if (fornecedorMatch > 0.7) { baseScore += 0.15; }
                }
                return { item: giapItem, baseScore: Math.min(baseScore, 1.0), bonusScore: 0 };
            });
            if (padroesConciliacao.length > 0) {
                padroesConciliacao.forEach(padrao => {
                    const similaridadeComPadrao = calculateSimilarity(systemDesc, `${padrao.descricaoSistema} ${padrao.fornecedorSistema}`);
                    if (similaridadeComPadrao > 0.7) {
                        scoredItems.forEach(scored => {
                            const giapDescCompleta = `${scored.item.Descri√ß√£o || ''} ${scored.item.Esp√©cie || ''} ${scored.item['Nome Fornecedor'] || ''}`;
                            const similaridadeComPadraoGiap = calculateSimilarity(giapDescCompleta, `${padrao.descricaoGIAP} ${padrao.fornecedorGIAP}`);
                            if (similaridadeComPadraoGiap > 0.6) { const boost = similaridadeComPadrao * similaridadeComPadraoGiap * 0.2; scored.bonusScore += boost; }
                        });
                    }
                });
            }
            scoredItems.forEach(scored => { scored.finalScore = Math.min(scored.baseScore + scored.bonusScore, 1.0); });
            scoredItems.sort((a, b) => b.finalScore - a.finalScore);
            const topScore = scoredItems.length > 0 ? scoredItems[0].finalScore : 0;
            const suggestionMap = new Map(scoredItems.map(si => [si.item.TOMBAMENTO, si.finalScore]));
            renderList('giap-list', scoredItems.map(si => si.item), 'TOMBAMENTO', 'Descri√ß√£o', { suggestions: suggestionMap, topScore: topScore });
        }
        
        const normalizeTombo = (tombo) => {
            if (!tombo) return ''; let str = String(tombo).trim();
            if (str.endsWith('.0')) { str = str.slice(0, -2); } return str;
        };

        function parseEstadoEOrigem(texto) {
            const textoCru = (texto || '').trim(); if (!textoCru) return { estado: 'Regular', origem: '' };
            const validEstados = ['Novo', 'Bom', 'Regular', 'Avariado']; let estadoFinal = 'Regular'; let origemFinal = '';
            for (const estado of validEstados) {
                if (normalizeStr(textoCru).startsWith(normalizeStr(estado))) {
                    estadoFinal = estado; let resto = textoCru.substring(estado.length).trim();
                    if ((resto.startsWith('(') && resto.endsWith(')')) || (resto.startsWith('[') && resto.endsWith(']'))) { resto = resto.substring(1, resto.length - 1).trim(); } else if (resto.startsWith('-')) { resto = resto.substring(1).trim(); }
                    if (resto) { const restoNormalizado = normalizeStr(resto); if (restoNormalizado.startsWith('doa√ß√£o') || restoNormalizado.startsWith('doacao')) { origemFinal = resto.replace(/^(doa√ß√£o|doacao)\s*/i, '').trim(); } }
                    return { estado: estadoFinal, origem: origemFinal };
                }
            }
            for (const estado of validEstados) { if (normalizeStr(textoCru) === normalizeStr(estado)) { return { estado: estado, origem: '' }; } }
            return { estado: 'Regular', origem: '' };
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div'); notification.className = `notification-toast ${type}`; notification.textContent = message; document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10); setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 500); }, duration);
        }

        function showOverlay(message) { overlayMessage.textContent = message; fullPageOverlay.classList.remove('hidden'); }
        function hideOverlay() { fullPageOverlay.classList.add('hidden'); }

        async function postData(functionName, payload) {
            if (!auth.currentUser) { throw new Error("Usu√°rio n√£o autenticado."); }
            const token = await getIdToken(auth.currentUser);
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ func: functionName, authToken: token, data: payload })
            });
            if (!response.ok) { throw new Error(`Erro na requisi√ß√£o: ${response.statusText}`); }
            const result = await response.json();
            if (result.status === 'error') { throw new Error(result.message); }
            return result.data;
        }

        onAuthStateChanged(auth, user => {
            document.getElementById('user-email-edit').textContent = user ? user.email : '';
            authGate.classList.toggle('hidden', !user);
            loadingScreen.classList.toggle('hidden', user);
            if(user) { if(!dataCache) loadData(); }
            else { loadingScreen.innerHTML = `<div class="text-center"><h2 class="text-2xl font-bold text-red-600">Acesso Negado</h2><p>Voc√™ precisa estar logado.</p></div>`; }
        });

        async function loadData(forceRefresh = false) {
             if (SCRIPT_URL.includes('COLE_A_URL')) {
                loadingScreen.innerHTML = `<div class="text-center"><h2 class="text-2xl font-bold text-red-600">Configura√ß√£o Incompleta</h2><p>A URL do App Script n√£o foi definida no arquivo.</p></div>`;
                return;
            }
            loadingScreen.classList.remove('hidden');
            if (!forceRefresh && dataCache) {
                feedbackStatus.textContent = 'Carregando dados do cache da sess√£o...';
                processLoadedData(dataCache);
                showNotification('Dados carregados do cache da sess√£o.', 'info');
                loadingScreen.classList.add('hidden');
                return;
            }
            try {
                feedbackStatus.textContent = 'Buscando dados da planilha...';
                const response = await fetch(`${SCRIPT_URL}?func=getAllData`);
                if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                
                dataCache = result.data;
                processLoadedData(dataCache);
                showNotification('Dados atualizados com sucesso!', 'success');
            } catch(e) {
                feedbackStatus.textContent = `Erro: ${e.message}`;
            } finally {
                loadingScreen.classList.add('hidden');
            }
        }

        function processLoadedData(data) {
            fullInventory = data.patrimonio || [];
            giapInventory = data.giap || [];
            unitMapping = data.unitMapping || {};
            customGiapUnits = data.customGiapUnits || [];
            padroesConciliacao = data.learningPatterns || [];

            giapMap = new Map(giapInventory.map(item => [normalizeTombo(item['TOMBAMENTO']), item]));
            normalizedSystemUnits.clear();
            fullInventory.forEach(item => { if (item.Unidade) { const n = normalizeStr(item.Unidade); if (!normalizedSystemUnits.has(n)) { normalizedSystemUnits.set(n, item.Unidade.trim()); } } });
            
            feedbackStatus.textContent = `Pronto. ${fullInventory.length} itens carregados.`;
            initializeUI();
        }
        
        function initializeUI() {
            populateEditableInventoryTab();
            populateUnitMappingTab();
            populateReconciliationTab();
            populatePendingTransfersTab();
            populateImportAndReplaceTab();
            populateGiapTab();
            populateNfTab();
        }

        function renderEditableTable() {
             const tipo = editFilterTipo.value; const unidade = editFilterUnidade.value; const estado = editFilterEstado.value; const desc = normalizeStr(editFilterDescricao.value);
            const filtered = fullInventory.filter(item => (!tipo || item.Tipo === tipo) && (!unidade || item.Unidade === unidade) && (!estado || item.Estado === estado) && (!desc || normalizeStr(item.Descri√ß√£o).includes(desc)));
            document.getElementById('unit-item-count').textContent = unidade ? `${filtered.length} iten(s)` : '';
            document.getElementById('add-item-to-unit-btn').classList.toggle('hidden', !unidade);
            const isSpecificFilterApplied = !!(unidade || desc || estado);
            const itemsToRender = isSpecificFilterApplied ? filtered : filtered.slice(0, 200);
            const headers = ['A√ß√µes', 'Tombamento', 'Descri√ß√£o', 'Tipo', 'Unidade', 'Localiza√ß√£o', 'Fornecedor', 'NF', 'Origem da Doa√ß√£o', 'Estado', 'Quantidade', 'Observa√ß√£o'];
            const estadoOptions = ['Bom', 'Regular', 'Avariado', 'Novo'];
            
            editTableBody.innerHTML = itemsToRender.map(item => {
                const itemData = dirtyItems.get(item.id) || item; const isDirty = dirtyItems.has(item.id);
                const estadoSelect = `<select data-field="Estado" class="w-full p-1 border rounded bg-white">${estadoOptions.map(opt => `<option value="${opt}" ${itemData.Estado === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
                const cells = headers.map(h => {
                    if (h === 'A√ß√µes') return `<td class="p-2 border-b"><button title="Sincronizar com GIAP" class="sync-giap-btn p-2 rounded-md hover:bg-blue-100 text-blue-600" data-doc-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="pointer-events-none" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z m-6.534 8.25.042.033a.25.25 0 0 1 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192V11.53a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1-.042.033z"/></svg></button></td>`;
                    if (h === 'Estado') return `<td class="p-2 border-b">${estadoSelect}</td>`;
                    const value = escapeHtml(itemData[h]); const inputType = (h === 'Quantidade') ? 'number' : 'text';
                    return `<td class="p-2 border-b"><input type="${inputType}" data-field="${h}" class="w-full p-1 border rounded" value="${value}"></td>`;
                }).join('');
                return `<tr id="row-${item.id}" data-doc-id="${item.id}" class="${isDirty ? 'is-dirty' : ''}">${cells}</tr>`;
            }).join('');
            if(!isSpecificFilterApplied && filtered.length > 200) { editTableBody.innerHTML += `<tr><td colspan="${headers.length}" class="text-center p-4 font-semibold text-orange-600">Apenas os primeiros 200 de ${filtered.length} resultados s√£o exibidos. Refine sua busca.</td></tr>`; }
        }

        function populateEditableInventoryTab() {
            const updateUnidades = () => {
                const selectedTipo = editFilterTipo.value;
                const unidades = [...new Set(fullInventory.filter(i => !selectedTipo || i.Tipo === selectedTipo).map(i => i.Unidade).filter(Boolean))].sort();
                editFilterUnidade.innerHTML = '<option value="">Todas as Unidades</option>' + unidades.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join('');
            };
            const tipos = [...new Set(fullInventory.map(i => i.Tipo).filter(Boolean))].sort();
            editFilterTipo.innerHTML = '<option value="">Todos os Tipos</option>' + tipos.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
            const estadoOptions = ['Novo', 'Bom', 'Regular', 'Avariado'];
            editFilterEstado.innerHTML = '<option value="">Todos os Estados</option>' + estadoOptions.map(e => `<option value="${e}">${e}</option>`).join('');
            const debouncedRenderTable = debounce(renderEditableTable, 300);
            editFilterTipo.onchange = () => { updateUnidades(); renderEditableTable(); };
            editFilterUnidade.onchange = renderEditableTable;
            editFilterEstado.onchange = renderEditableTable;
            editFilterDescricao.oninput = debouncedRenderTable;
            updateUnidades();
            renderEditableTable();
        }

        function populateUnitMappingTab() {
            const systemTypes = [...new Set(fullInventory.map(i => i.Tipo).filter(Boolean))].sort();
            mapFilterTipo.innerHTML = '<option value="">Todos os Tipos</option>' + systemTypes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
            updateSystemUnitOptions();
            renderSavedMappings();
            updateGiapUnitOptions();
        }

        function updateSystemUnitOptions() {
            const selectedType = mapFilterTipo.value;
            const linkedSystemUnits = Object.keys(unitMapping);
            const systemUnits = [...normalizedSystemUnits.values()].filter(unit => {
                const item = fullInventory.find(i => i.Unidade === unit); const isCorrectType = !selectedType || item?.Tipo === selectedType;
                return isCorrectType && !linkedSystemUnits.includes(unit);
            }).sort();
            mapSystemUnitSelect.innerHTML = systemUnits.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join('');
        }

        function updateGiapUnitOptions() {
            const filterText = normalizeStr(mapGiapFilter.value);
            let allGiapUnitsFromSheet = [...new Set(giapInventory.map(i => i.Unidade).filter(Boolean))];
            let allGiapUnits = [...new Set([...allGiapUnitsFromSheet, ...customGiapUnits.map(u => u.name)])].sort();
            const selectedSystemUnits = Array.from(mapSystemUnitSelect.selectedOptions).map(opt => opt.value);
            const allLinkedGiapUnits = new Set(Object.values(unitMapping).flat());
            const currentMapping = new Set();
            selectedSystemUnits.forEach(unit => { if (unitMapping[unit]) { unitMapping[unit].forEach(giapUnit => currentMapping.add(giapUnit)); } });
            if (filterText) { allGiapUnits = allGiapUnits.filter(unit => normalizeStr(unit).includes(filterText)); }
            const keywords = new Set();
            selectedSystemUnits.forEach(unit => { unit.split('/').forEach(part => keywords.add(normalizeStr(part.trim()))); });
            const suggestions = []; const available = []; const usedByOthers = [];
            allGiapUnits.forEach(unit => {
                const optionHtml = `<option value="${escapeHtml(unit)}">${escapeHtml(unit)}</option>`;
                const isSuggestion = keywords.size > 0 && Array.from(keywords).some(kw => kw && normalizeStr(unit).includes(kw));
                if (!allLinkedGiapUnits.has(unit) || currentMapping.has(unit)) { if (isSuggestion && !filterText) { suggestions.push(optionHtml); } else { available.push(optionHtml); } } else { usedByOthers.push(optionHtml); }
            });
            const suggestionHeader = suggestions.length > 0 ? `<optgroup label="Sugest√µes">` : ''; const suggestionFooter = suggestions.length > 0 ? `</optgroup>` : '';
            const usedHeader = usedByOthers.length > 0 ? `<optgroup label="J√° Mapeadas (em outras unidades)">` : ''; const usedFooter = usedByOthers.length > 0 ? `</optgroup>` : '';
            mapGiapUnitMultiselect.innerHTML = suggestionHeader + suggestions.join('') + suggestionFooter + available.join('') + usedHeader + usedByOthers.join('') + usedFooter;
        }

        function renderSavedMappings() {
            const mappedUnits = Object.keys(unitMapping).filter(key => unitMapping[key]?.length > 0).sort();
            savedMappingsContainer.innerHTML = mappedUnits.length > 0 ? mappedUnits.map(systemUnit => `
                <div class="p-2 border rounded-md bg-slate-50 flex justify-between items-center">
                    <div><strong class="text-sm">${escapeHtml(systemUnit)}</strong><p class="text-xs text-slate-600">‚Üí ${unitMapping[systemUnit].join(', ')}</p></div>
                    <button class="delete-mapping-btn text-red-500 hover:text-red-700 p-1" data-system-unit="${escapeHtml(systemUnit)}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3h11V2h-11v1z"/></svg></button>
                </div>`).join('') : `<p class="text-sm text-slate-500">Nenhuma liga√ß√£o salva ainda.</p>`;
        }
        
        function populatePendingTransfersTab() {
             const pendingTransfers = fullInventory.filter(item => {
                const tombo = item.Tombamento?.trim();
                if (!tombo || normalizeStr(tombo).includes('permuta') || tombo.toLowerCase() === 's/t') return false;
                const giapItem = giapMap.get(tombo); if (!giapItem) return false;
                const systemUnit = (item.Unidade || '').trim(); const giapUnit = giapItem.Unidade; if (!systemUnit || !giapUnit) return false;
                if (!unitMapping[systemUnit] || unitMapping[systemUnit].length === 0) { return normalizeStr(systemUnit) !== normalizeStr(giapUnit); }
                const mappedGiapUnits = unitMapping[systemUnit];
                return !mappedGiapUnits.map(u => normalizeStr(u)).includes(normalizeStr(giapUnit));
            });
            const groupedTransfers = pendingTransfers.reduce((acc, item) => {
                const tipo = item.Tipo || 'Sem Tipo'; if (!acc[tipo]) acc[tipo] = {};
                const unit = item.Unidade || 'Unidade Desconhecida'; if (!acc[tipo][unit]) { acc[tipo][unit] = []; } acc[tipo][unit].push(item); return acc;
            }, {});
            const tipos = Object.keys(groupedTransfers).sort();
            if (tipos.length === 0) { pendingTransfersContainer.innerHTML = `<p class="text-slate-500 text-center p-4">Nenhuma transfer√™ncia pendente encontrada.</p>`;
            } else {
                pendingTransfersContainer.innerHTML = tipos.map(tipo => {
                    const units = Object.keys(groupedTransfers[tipo]).sort();
                    const unitsHtml = units.map(unit => {
                        const items = groupedTransfers[tipo][unit];
                        const itemsHtml = items.map(item => {
                            const giapItem = giapMap.get(item.Tombamento.trim()); const giapUnitName = giapItem ? giapItem.Unidade : 'N/A';
                            return `<div class="p-3 border-t text-sm flex justify-between items-center">
                                        <div><label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 transfer-item-checkbox" data-id="${item.id}" data-giap-unit="${escapeHtml(giapUnitName)}"><span class="ml-3"><strong>${escapeHtml(item.Descri√ß√£o)}</strong> (T: ${escapeHtml(item.Tombamento)})</span></label></div>
                                        <div class="text-right"><p class="text-xs text-slate-500">Destino na Planilha</p><p class="font-semibold text-red-600">${escapeHtml(giapUnitName)}</p></div>
                                    </div>`;
                        }).join('');
                        return `<details class="bg-white rounded-lg shadow-sm border mt-2"><summary class="p-4 font-semibold cursor-pointer flex justify-between items-center hover:bg-slate-50"><span>${escapeHtml(unit)}</span><span class="text-sm font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">${items.length} ${items.length > 1 ? 'itens' : 'item'}</span></summary><div class="px-4 pb-2 border-t"><div class="py-2 flex justify-between items-center"><label class="flex items-center text-sm font-medium"><input type="checkbox" class="h-4 w-4 mr-2 select-all-in-unit">Selecionar Todos</label><div class="flex gap-2"><button class="keep-selected-btn text-xs bg-yellow-100 text-yellow-700 px-3 py-1 rounded-md hover:bg-yellow-200">Manter na Unidade</button><button class="transfer-selected-btn text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200">Transferir Selecionados</button></div></div>${itemsHtml}</div></details>`;
                    }).join('');
                    return `<div class="mb-4"><h3 class="text-lg font-bold text-slate-700 p-2 bg-slate-200 rounded-t-lg">${tipo}</h3>${unitsHtml}</div>`;
                }).join('');
            }
        }
        
        function parsePtBrDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0); 
            const parts = dateStr.split('/');
            if (parts.length === 3) { return new Date(parts[2], parts[1] - 1, parts[0]); } return new Date(0);
        }

        function populateNfTab() {
            if (giapInventory.length === 0) return;
            const giapWithNf = giapInventory.filter(item => item.NF && item.NF.trim() !== '').sort((a, b) => parsePtBrDate(b.Cadastro) - parsePtBrDate(a.Cadastro));
            processedNfData = giapWithNf.reduce((acc, item) => {
                const nf = item.NF.trim();
                if (!acc[nf]) { acc[nf] = { items: [], fornecedor: item['Nome Fornecedor'] || 'N√£o especificado', tipoEntrada: item['Tipo Entrada'] || 'N/A', dataCadastro: item.Cadastro }; }
                acc[nf].items.push(item); return acc;
            }, {});
            renderNfList(); 
        }

        function renderNfList() {
            const container = document.getElementById('notas-fiscais-container'); container.innerHTML = '';
            const tomboMap = new Map(fullInventory.map(item => [item.Tombamento?.trim(), item]));
            const nfSearchTerm = document.getElementById('nf-search').value.toLowerCase(); const nfItemSearchTerm = document.getElementById('nf-item-search').value.toLowerCase();
            const nfTipoEntrada = document.getElementById('nf-tipo-entrada').value; const startDateStr = document.getElementById('nf-date-start').value; const endDateStr = document.getElementById('nf-date-end').value;
            const startDate = startDateStr ? new Date(startDateStr) : null; const endDate = endDateStr ? new Date(endDateStr) : null;
            if (endDate) { endDate.setHours(23, 59, 59, 999); } if (startDate) { startDate.setHours(0, 0, 0, 0); }
            const filteredNfs = Object.keys(processedNfData).filter(nf => {
                const nfGroup = processedNfData[nf];
                if (nfSearchTerm && !nf.toLowerCase().includes(nfSearchTerm)) return false;
                if (nfItemSearchTerm) { const itemMatch = nfGroup.items.some(item => (item.Descri√ß√£o || '').toLowerCase().includes(nfItemSearchTerm) || (item.Esp√©cie || '').toLowerCase().includes(nfItemSearchTerm)); if (!itemMatch) return false; }
                if (nfTipoEntrada && nfGroup.tipoEntrada !== nfTipoEntrada) return false;
                const nfDate = parsePtBrDate(nfGroup.dataCadastro); if (startDate && nfDate < startDate) return false; if (endDate && nfDate > endDate) return false;
                return true;
            });
            if (filteredNfs.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center p-4">Nenhuma nota fiscal encontrada com os filtros aplicados.</p>`; return; }
            const categorizedNfs = filteredNfs.reduce((acc, nfKey) => {
                const nfGroup = processedNfData[nfKey]; const category = nfGroup.tipoEntrada || 'Outros';
                if (!acc[category]) { acc[category] = []; } acc[category].push(nfKey); return acc;
            }, {});
            const categories = Object.keys(categorizedNfs).sort();
            categories.forEach(category => {
                const categoryHeader = document.createElement('h3'); categoryHeader.className = 'text-lg font-bold text-slate-700 p-2 bg-slate-100 rounded-t-lg mt-6 first:mt-0'; categoryHeader.textContent = category; container.appendChild(categoryHeader);
                const nfsInCategory = categorizedNfs[category];
                nfsInCategory.forEach(nf => {
                    const nfGroup = processedNfData[nf]; const nfDetails = document.createElement('details'); nfDetails.className = 'bg-white rounded-lg shadow-sm border mb-3 border-t-0 rounded-t-none'; nfDetails.open = false;
                    const itemSummaryText = nfGroup.items.slice(0, 2).map(i => escapeHtml(i.Descri√ß√£o || i.Esp√©cie)).join(', ') + (nfGroup.items.length > 2 ? '...' : '');
                    const nfSummary = document.createElement('summary'); nfSummary.className = 'p-4 font-semibold cursor-pointer grid grid-cols-1 md:grid-cols-3 gap-4 items-center hover:bg-slate-50';
                    nfSummary.innerHTML = `<div class="md:col-span-2"><p class="text-xs text-slate-500">NF: <strong class="text-blue-700 text-sm">${escapeHtml(nf)}</strong> | Fornecedor: <strong>${escapeHtml(nfGroup.fornecedor)}</strong></p><p class="text-xs text-slate-500 mt-1 truncate">Itens: ${itemSummaryText}</p></div><div><p class="text-xs text-slate-500">Data Cadastro</p><strong>${escapeHtml(nfGroup.dataCadastro)}</strong></div>`;
                    nfDetails.appendChild(nfSummary); const itemsListContainer = document.createElement('div'); itemsListContainer.className = 'p-4 border-t border-slate-200 space-y-2';
                    nfGroup.items.forEach(item => {
                        const tombo = item.TOMBAMENTO?.trim(); const allocatedItem = tombo ? giapMap.get(tombo) : undefined;
                        let allocationHtml = `<span class="px-2 py-1 text-xs font-semibold text-slate-700 bg-slate-200 rounded-full">N√£o Alocado</span>`;
                        if (allocatedItem) {
                            const systemItem = fullInventory.find(i => i.Tombamento?.trim() === tombo);
                             if (systemItem) { allocationHtml = `<div><span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Alocado</span><p class="text-xs text-slate-600 mt-1 text-right">‚Üí <strong>${escapeHtml(systemItem.Unidade)}</strong> (${escapeHtml(systemItem.Tipo)})</p></div>`; }
                        }
                        const itemDiv = document.createElement('div'); itemDiv.className = 'p-3 border rounded-md flex justify-between items-center bg-slate-50/50';
                        itemDiv.innerHTML = `<div class="flex-1"><p class="font-bold text-slate-800">${escapeHtml(item.Descri√ß√£o || item.Esp√©cie)}</p><p class="text-sm text-slate-500">Tombamento: <span class="font-mono">${escapeHtml(tombo || 'N/D')}</span></p></div><div class="text-right ml-4">${allocationHtml}</div>`;
                        itemsListContainer.appendChild(itemDiv);
                    });
                    nfDetails.appendChild(itemsListContainer); container.appendChild(nfDetails);
                });
            });
        }

        function populateGiapTab() {
            const headers = ['TOMBAMENTO', 'Descri√ß√£o', 'Cadastro', 'NF', 'Nome Fornecedor', 'Tipo Entrada', 'Unidade', 'Valor NF', 'Esp√©cie'];
            giapTableBody.innerHTML = giapInventory.map(item => `<tr class="border-b">${headers.map(h => `<td class="p-2 text-slate-700">${escapeHtml(item[h])}</td>`).join('')}</tr>`).join('');
        }
        
        function populateImportAndReplaceTab() {
            const tipos = [...new Set(fullInventory.map(item => item.Tipo).filter(Boolean))].sort();
            const selects = [document.getElementById('mass-transfer-tipo'), document.getElementById('replace-tipo'), document.getElementById('edit-by-desc-tipo')];
            selects.forEach(select => { if(select) select.innerHTML = '<option value="">Selecione um Tipo</option>' + tipos.map(t => `<option value="${t}">${t}</option>`).join(''); });
            const setupUnitSelect = (tipoSelectId, unitSelectId) => {
                 document.getElementById(tipoSelectId).addEventListener('change', () => {
                    const selectedTipo = document.getElementById(tipoSelectId).value; const unitSelect = document.getElementById(unitSelectId);
                    if (!selectedTipo) { unitSelect.innerHTML = ''; unitSelect.disabled = true; return; }
                    const unidades = [...new Set(fullInventory.filter(i => i.Tipo === selectedTipo).map(i => i.Unidade).filter(Boolean))].sort();
                    unitSelect.innerHTML = '<option value="">Selecione uma Unidade</option>' + unidades.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join(''); unitSelect.disabled = false;
                });
            };
            setupUnitSelect('mass-transfer-tipo', 'mass-transfer-unit'); setupUnitSelect('replace-tipo', 'replace-unit'); setupUnitSelect('edit-by-desc-tipo', 'edit-by-desc-unit');
        }
       
        function populateReconciliationTab() {
            const tipos = [...new Set(fullInventory.map(item => item.Tipo).filter(Boolean))].sort(); const sel = document.getElementById('filter-tipo');
            sel.innerHTML = '<option value="">Todos os Tipos</option>' + tipos.map(t => `<option value="${t}">${t}</option>`).join('');
            const tombarFilterTipo = document.getElementById('tombar-filter-tipo');
            tombarFilterTipo.innerHTML = '<option value="">Todos os Tipos</option>' + tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function renderList(containerId, arr, keyField, primaryLabelField, suggestionInfo = null) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            if (!arr || arr.length === 0) { container.innerHTML = `<p class="p-4 text-slate-500 text-center">Nenhum item encontrado.</p>`; return; }
            arr.forEach((item, index) => {
                const id = item[keyField]; const div = document.createElement('div'); div.className = 'reconciliation-list-item card p-2 text-sm'; div.dataset.id = id;
                let detailsHtml = '';
                if (containerId === 'system-list') {
                    const fornecedor = escapeHtml(item.Fornecedor || 'N/D'); const estado = escapeHtml(item.Estado || 'N/A'); const obs = escapeHtml(item.Observa√ß√£o || 'Nenhuma');
                    detailsHtml = `<strong>${escapeHtml(item[primaryLabelField])}</strong><p class="text-xs text-slate-500 mt-1">Fornecedor: ${fornecedor} | Estado: <strong>${estado}</strong></p><p class="text-xs text-slate-400 mt-1">Obs: ${obs}</p>`;
                } else {
                    const descricao = escapeHtml(item.Descri√ß√£o || item.Esp√©cie || 'N/A'); const dataCadastro = escapeHtml(item.Cadastro || 'N/D'); const fornecedor = escapeHtml(item['Nome Fornecedor'] || 'N/D');
                    const tombo = escapeHtml(item[keyField]); const valorNf = escapeHtml(item['Valor NF'] || 'N/A');
                    detailsHtml = `<div class="flex justify-between items-start"><div class="flex-1"><strong>${tombo} - ${descricao}</strong><p class="text-xs text-slate-500 mt-1">Cadastro: <strong>${dataCadastro}</strong> | Fornecedor: <strong>${fornecedor}</strong></p></div><div class="text-right ml-2"><p class="text-xs text-slate-500">Valor NF</p><strong class="text-sm text-green-700">${valorNf}</strong></div></div>`;
                }
                div.innerHTML = detailsHtml;
                if (suggestionInfo && suggestionInfo.suggestions.has(id)) {
                    const score = suggestionInfo.suggestions.get(id);
                    if (index === 0 && score > 0.7) { div.style.backgroundColor = '#dbeafe'; div.style.borderLeft = '4px solid #3b82f6'; } 
                    else if (score > 0.5) { div.style.backgroundColor = '#e0f2fe'; div.style.borderLeft = '4px solid #0ea5e9'; }
                }
                div.onclick = (event) => handleSelect(containerId, id, item, event.currentTarget); container.append(div);
            });
        }
        
        function getConciliationData() {
            const unidade = document.getElementById('filter-unidade').value.trim(); if (!unidade) return { systemItems: [], giapItems: [] };
            const systemFilterText = normalizeStr(document.getElementById('system-list-filter').value); const giapFilterText = normalizeStr(document.getElementById('giap-list-filter').value);
            const usedTombamentos = new Set(fullInventory.map(i => normalizeStr(i.Tombamento)).filter(Boolean));
            linksToCreate.forEach(link => usedTombamentos.add(normalizeTombo(link.giapItem.TOMBAMENTO)));
            const mappedGiapUnits = unitMapping[unidade] || [unidade];
            const systemItems = fullInventory.filter(i => {
                const tombo = (i.Tombamento || '').trim(); const isPending = linksToCreate.some(l => l.systemItem.id === i.id);
                return !isPending && i.Unidade === unidade && (!tombo || tombo.toLowerCase() === 's/t') && !normalizeStr(tombo).includes('permuta') && normalizeStr(i.Descri√ß√£o).includes(systemFilterText);
            });
            const giapItems = giapInventory.filter(g => {
                const tomboTrimmed = normalizeTombo(g.TOMBAMENTO); const giapDesc = normalizeStr(g.Descri√ß√£o || g.Esp√©cie);
                return tomboTrimmed && !usedTombamentos.has(tomboTrimmed) && mappedGiapUnits.map(normalizeStr).includes(normalizeStr(g.Unidade)) && giapDesc.includes(giapFilterText);
            });
            return { systemItems, giapItems };
        }

        function handleSelect(containerId, id, obj, element) {
            if (element.classList.contains('linked')) return;
            if (containerId === 'system-list') {
                clearGiapImportSelection(); selSys = { id, obj }; selGiap = null;
                document.querySelectorAll('#giap-list .selected').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('#system-list .selected, #system-list .selected-for-import').forEach(el => el.classList.remove('selected', 'selected-for-import'));
                element.classList.add('selected'); suggestGiapMatchesComAprendizado(obj); 
            } else if (containerId === 'giap-list' && selSys) {
                selGiap = { tomb: id, obj };
                document.querySelectorAll('#giap-list .selected, #giap-list .selected-for-import').forEach(el => el.classList.remove('selected', 'selected-for-import'));
                element.classList.add('selected'); openDescriptionChoiceModal();
            } else if (containerId === 'giap-list' && !selSys) {
                element.classList.toggle('selected-for-import');
                const index = giapItemsForImport.findIndex(item => item.TOMBAMENTO === id);
                if (index > -1) { giapItemsForImport.splice(index, 1); } else { giapItemsForImport.push(obj); }
                updateImportButton();
            }
        }

        function updateImportButton() {
            const count = giapItemsForImport.length; const btn = document.getElementById('import-giap-btn');
            document.getElementById('giap-import-count').textContent = count; btn.disabled = count === 0;
        }

        function clearGiapImportSelection() {
            giapItemsForImport = []; document.querySelectorAll('#giap-list .selected-for-import').forEach(el => el.classList.remove('selected-for-import')); updateImportButton();
        }
        
        function addLinkToCreate(useGiapDescription) {
            const link = { systemItem: selSys.obj, giapItem: selGiap.obj, useGiapDescription }; linksToCreate.push(link); renderCreatedLinks();
            document.querySelector(`#system-list div[data-id='${selSys.id}']`).classList.add('linked'); document.querySelector(`#giap-list div[data-id='${selGiap.tomb}']`).classList.add('linked');
            selSys = selGiap = null; document.querySelectorAll('.reconciliation-list-item.selected').forEach(el => el.classList.remove('selected'));
        }

        function renderCreatedLinks() {
            const container = document.getElementById('created-links');
            container.innerHTML = linksToCreate.map((link, index) => {
                const systemDesc = link.systemItem.Descri√ß√£o; const giapDesc = link.giapItem.Descri√ß√£o || link.giapItem.Esp√©cie; const finalDesc = link.useGiapDescription ? giapDesc : systemDesc;
                return `<div class="created-link-item card link-success p-2 text-sm bg-green-50 border-l-4 border-green-500"><span><strong>S/T:</strong> ${escapeHtml(systemDesc)} ‚Üî <strong>Tombo:</strong> ${escapeHtml(link.giapItem.TOMBAMENTO)}<br><span class="text-xs text-blue-700">Descri√ß√£o a ser salva: "${escapeHtml(finalDesc)}"</span></span><button class="delete-link-btn" data-index="${index}" title="Remover V√≠nculo"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3h11V2h-11v1z"/></svg></button></div>`;
            }).join('');
        }
        
        function renderConciliationLists() {
            const unidade = document.getElementById('filter-unidade').value.trim();
            if (!unidade) { document.getElementById('system-list').innerHTML = `<p class="p-4 text-slate-500 text-center">Selecione uma unidade e clique em carregar.</p>`; document.getElementById('giap-list').innerHTML = `<p class="p-4 text-slate-500 text-center">Selecione uma unidade e clique em carregar.</p>`; return; }
            const { systemItems, giapItems } = getConciliationData();
            renderList('system-list', systemItems, 'id', 'Descri√ß√£o'); renderList('giap-list', giapItems, 'TOMBAMENTO', 'Descri√ß√£o');
        }

        function openAddItemModal(defaults = {}) {
            const modal = document.getElementById('add-item-modal'); const form = document.getElementById('add-item-form'); form.reset();
            document.getElementById('add-item-unidade').value = defaults.Unidade || ''; document.getElementById('add-item-tipo').value = defaults.Tipo || '';
            modal.classList.remove('hidden'); setTimeout(() => { modal.querySelector('.modal-overlay')?.classList.remove('opacity-0'); modal.querySelector('.modal-container')?.classList.remove('opacity-0', 'scale-95'); }, 10);
        }

        function closeAddItemModal() {
            const modal = document.getElementById('add-item-modal'); modal.querySelector('.modal-overlay')?.classList.add('opacity-0'); modal.querySelector('.modal-container')?.classList.add('opacity-0', 'scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function openDescriptionChoiceModal() {
            if (!selSys || !selGiap) return;
            document.getElementById('desc-choice-tombo').textContent = selGiap.tomb; document.getElementById('desc-choice-current').textContent = selSys.obj.Descri√ß√£o;
            document.getElementById('desc-choice-new').textContent = selGiap.obj.Descri√ß√£o || selGiap.obj.Esp√©cie;
            descChoiceModal.classList.remove('hidden');
        }

        function closeDescriptionChoiceModal() { descChoiceModal.classList.add('hidden'); }

        function renderItensATombar() {
            const container = document.getElementById('itens-a-tombar-container');
            const tipo = document.getElementById('tombar-filter-tipo').value; const unidade = document.getElementById('tombar-filter-unidade').value;
            const itemsPendentes = fullInventory.filter(item => item.etiquetaPendente === true && (!tipo || item.Tipo === tipo) && (!unidade || item.Unidade === unidade));
            if (itemsPendentes.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center p-4">Nenhum item pendente de tombamento com os filtros selecionados.</p>'; return; }
            const groupedByTipo = itemsPendentes.reduce((acc, item) => { const tipoKey = item.Tipo || 'Sem Tipo'; if (!acc[tipoKey]) acc[tipoKey] = []; acc[tipoKey].push(item); return acc; }, {});
            let html = '';
            for (const tipo of Object.keys(groupedByTipo).sort()) {
                html += `<h3 class="text-lg font-bold text-slate-700 p-2 bg-slate-100 rounded-t-lg mt-4">${tipo}</h3>`;
                const groupedByUnidade = groupedByTipo[tipo].reduce((acc, item) => { const unidadeKey = item.Unidade || 'Sem Unidade'; if (!acc[unidadeKey]) acc[unidadeKey] = []; acc[unidadeKey].push(item); return acc; }, {});
                for (const unidade of Object.keys(groupedByUnidade).sort()) {
                    html += `<details class="bg-white rounded-lg shadow-sm border mb-2" open><summary class="p-4 font-semibold cursor-pointer hover:bg-slate-50">${unidade}</summary><div class="p-2 border-t"><table class="w-full text-sm"><thead><tr class="border-b"><th class="p-2 text-left">Descri√ß√£o</th><th class="p-2 text-left">Novo Tombo</th><th class="p-2 text-left">A√ß√£o</th></tr></thead><tbody>`;
                    groupedByUnidade[unidade].forEach(item => { html += `<tr class="border-b hover:bg-green-50"><td class="p-2">${escapeHtml(item.Descri√ß√£o)}</td><td class="p-2 font-mono">${escapeHtml(item.Tombamento)}</td><td class="p-2"><button data-id="${item.id}" class="confirmar-tombamento-btn text-xs bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200">Confirmar Tombamento</button></td></tr>`; });
                    html += `</tbody></table></div></details>`;
                }
            }
            container.innerHTML = html;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            forceRefreshBtn.addEventListener('click', () => { showNotification('For√ßando atualiza√ß√£o do servidor...', 'info'); dataCache = null; loadData(true); });
            logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
            navButtons.forEach(button => { button.addEventListener('click', (e) => { const tabName = e.currentTarget.dataset.tab; navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName)); contentPanes.forEach(pane => pane.classList.toggle('hidden', !pane.id.includes(tabName))); }); });
            
            saveAllChangesBtn.addEventListener('click', async () => {
                if (dirtyItems.size === 0) return; showOverlay(`Salvando ${dirtyItems.size} altera√ß√µes...`);
                const payload = Array.from(dirtyItems.entries()).map(([id, data]) => ({ id, ...data }));
                try {
                    await postData('saveAllChanges', payload);
                    dirtyItems.clear(); saveAllChangesBtn.disabled = true;
                    showNotification(`${payload.length} altera√ß√µes salvas! Recarregando...`, 'success');
                    setTimeout(() => { dataCache = null; loadData(true); }, 1500);
                } catch (error) { showNotification(`Erro ao salvar: ${error.message}`, 'error');
                } finally { hideOverlay(); }
            });
            
            editTableBody.addEventListener('change', (e) => {
                const input = e.target.closest('input, select'); if (!input) return;
                const row = input.closest('tr'); const docId = row.dataset.docId; const field = input.dataset.field; const value = (input.type === 'number' ? Number(input.value) : input.value);
                if (field === 'Tombamento' && value && !normalizeStr(String(value)).includes('permuta') && String(value).toLowerCase() !== 's/t') { const duplicate = fullInventory.find(item => item.id !== docId && item.Tombamento === value); if (duplicate) { showNotification(`Aten√ß√£o: Tombamento ${value} j√° alocado na unidade ${duplicate.Unidade}.`, 'warning', 5000); } }
                const currentUpdates = dirtyItems.get(docId) || {};
                dirtyItems.set(docId, { ...currentUpdates, [field]: value });
                row.classList.add('is-dirty'); saveAllChangesBtn.disabled = false;
            });

            editTableBody.addEventListener('click', (e) => {
                const syncBtn = e.target.closest('.sync-giap-btn'); if (!syncBtn) return;
                const docId = syncBtn.dataset.docId; const row = document.getElementById(`row-${docId}`); if (!row) return;
                const tomboInput = row.querySelector('[data-field="Tombamento"]'); const tomboValue = tomboInput.value.trim();
                if (!tomboValue) { showNotification('O campo Tombamento est√° vazio.', 'warning'); return; }
                const giapItem = giapMap.get(tomboValue);
                if (giapItem) {
                    const currentDesc = row.querySelector('[data-field="Descri√ß√£o"]').value; const newDesc = giapItem.Descri√ß√£o || giapItem.Esp√©cie || '';
                    document.getElementById('sync-item-tombo').textContent = tomboValue; document.getElementById('sync-current-desc').textContent = currentDesc; document.getElementById('sync-new-desc').textContent = newDesc;
                    syncUpdateAllBtn.dataset.docId = docId; syncKeepDescBtn.dataset.docId = docId;
                    syncConfirmModal.classList.remove('hidden');
                } else { showNotification(`Tombo ${tomboValue} n√£o encontrado na planilha GIAP.`, 'error'); }
            });

            const handleSync = (docId, updateDescription) => {
                 const row = document.getElementById(`row-${docId}`); if (!row) return;
                const tomboValue = row.querySelector('[data-field="Tombamento"]').value.trim(); const giapItem = giapMap.get(tomboValue); if (!giapItem) return;
                const descInput = row.querySelector('[data-field="Descri√ß√£o"]'); const fornInput = row.querySelector('[data-field="Fornecedor"]'); const nfInput = row.querySelector('[data-field="NF"]');
                const newDesc = giapItem.Descri√ß√£o || giapItem.Esp√©cie || ''; const newForn = giapItem['Nome Fornecedor'] || ''; const newNf = giapItem.NF || '';
                if (updateDescription) { descInput.value = newDesc; } fornInput.value = newForn; nfInput.value = newNf;
                const currentUpdates = dirtyItems.get(docId) || {};
                const updatedItem = { ...currentUpdates, Fornecedor: newForn, NF: newNf };
                if (updateDescription) { updatedItem.Descri√ß√£o = newDesc; }
                dirtyItems.set(docId, updatedItem); row.classList.add('is-dirty'); saveAllChangesBtn.disabled = false;
                syncConfirmModal.classList.add('hidden'); showNotification(`Dados do Tombo ${tomboValue} sincronizados!`, 'success');
            };

            syncUpdateAllBtn.addEventListener('click', (e) => handleSync(e.target.dataset.docId, true));
            syncKeepDescBtn.addEventListener('click', (e) => handleSync(e.target.dataset.docId, false));
            syncCancelBtn.addEventListener('click', () => syncConfirmModal.classList.add('hidden'));

            document.getElementById('add-item-to-unit-btn').addEventListener('click', () => { openAddItemModal({ Tipo: document.getElementById('edit-filter-tipo').value, Unidade: document.getElementById('edit-filter-unidade').value }); });

            document.getElementById('add-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newItem = {
                    Tombamento: document.getElementById('add-item-tombamento').value, Descri√ß√£o: document.getElementById('add-item-descricao').value, Estado: document.getElementById('add-item-estado').value,
                    Unidade: document.getElementById('add-item-unidade').value, Tipo: document.getElementById('add-item-tipo').value, Localiza√ß√£o: '', Fornecedor: '', NF: '', 'Origem da Doa√ß√£o': '', Quantidade: 1,
                    Observa√ß√£o: 'Adicionado via edi√ß√£o r√°pida.',
                };
                try {
                    showOverlay('Salvando novo item...'); await postData('addNewItem', { item: newItem });
                    showNotification('Item adicionado com sucesso! Recarregando...', 'success'); setTimeout(() => { dataCache = null; loadData(true); }, 1500);
                } catch (error) { hideOverlay(); showNotification(`Erro: ${error.message}`, 'error'); }
            });

            document.querySelectorAll('.js-close-modal-add').forEach(btn => btn.addEventListener('click', closeAddItemModal));
            mapFilterTipo.addEventListener('change', updateSystemUnitOptions);
            mapSystemUnitSelect.addEventListener('change', updateGiapUnitOptions);
            mapGiapFilter.addEventListener('input', debounce(updateGiapUnitOptions, 300));
            
            saveMappingBtn.addEventListener('click', async () => {
                const systemUnits = Array.from(mapSystemUnitSelect.selectedOptions).map(opt => opt.value.trim()); if (systemUnits.length === 0) return showNotification("Selecione uma ou mais Unidades do Sistema.", "warning");
                const giapUnits = Array.from(mapGiapUnitMultiselect.selectedOptions).map(opt => opt.value);
                const newMapping = {}; systemUnits.forEach(systemUnit => { newMapping[systemUnit] = giapUnits; });
                try {
                    feedbackStatus.innerHTML = `<div class="saving-spinner inline-block mr-2"></div> Salvando...`;
                    const updatedMappings = await postData('saveMapping', { newMapping });
                    unitMapping = updatedMappings; showNotification('Mapeamento salvo!', 'success'); feedbackStatus.textContent = `Mapeamento salvo!`; populateUnitMappingTab();
                } catch (error) { showNotification(`Erro ao salvar: ${error.message}`, 'error'); }
            });
            
            savedMappingsContainer.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-mapping-btn');
                if (deleteBtn) {
                    const systemUnit = (deleteBtn.dataset.systemUnit || '').trim();
                    try {
                        feedbackStatus.innerHTML = `<div class="saving-spinner inline-block mr-2"></div> Removendo...`;
                        const updatedMappings = await postData('deleteMapping', { systemUnit });
                        unitMapping = updatedMappings; showNotification(`Liga√ß√£o removida.`, 'success'); feedbackStatus.textContent = `Liga√ß√£o removida.`; populateUnitMappingTab();
                    } catch (error) { showNotification(`Erro ao remover: ${error.message}`, 'error'); }
                }
            });

            pendingTransfersContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.classList.contains('select-all-in-unit')) { const detailsContent = target.closest('details'); const checkboxes = detailsContent.querySelectorAll('.transfer-item-checkbox'); checkboxes.forEach(cb => cb.checked = target.checked); return; }
                const actionButton = target.closest('.keep-selected-btn, .transfer-selected-btn'); if (!actionButton) return;
                const detailsContent = actionButton.closest('details'); const selectedCheckboxes = detailsContent.querySelectorAll('.transfer-item-checkbox:checked');
                if (selectedCheckboxes.length === 0) { showNotification('Nenhum item selecionado para a a√ß√£o.', 'warning'); return; }
                
                const isTransfer = actionButton.classList.contains('transfer-selected-btn');
                const items = Array.from(selectedCheckboxes).map(cb => ({ id: cb.dataset.id, giapUnit: cb.dataset.giapUnit }));
                const actionDescription = `${isTransfer ? 'Transferindo' : 'Mantendo'} ${items.length} iten(s)...`;
                
                showOverlay(actionDescription);
                try {
                    await postData('handleTransferAction', { items, isTransfer });
                    showNotification('A√ß√£o conclu√≠da com sucesso! A p√°gina ser√° recarregada.', 'success'); setTimeout(() => { dataCache = null; loadData(true); }, 1500);
                } catch (error) { hideOverlay(); showNotification(`Erro: ${error.message}`, 'error'); }
            });
            
            document.getElementById('filter-tipo').addEventListener('change', () => {
                const tipo = document.getElementById('filter-tipo').value;
                const unidades = [...new Set(fullInventory.filter(i => !tipo || i.Tipo === tipo).map(i => i.Unidade).filter(Boolean))].sort();
                const selU = document.getElementById('filter-unidade'); selU.innerHTML = '<option value="">Selecione uma Unidade</option>' + unidades.map(u => `<option>${u}</option>`).join('');
            });

            document.getElementById('load-conciliar').addEventListener('click', () => {
                const unidade = document.getElementById('filter-unidade').value.trim(); if (!unidade) return showNotification('Por favor, selecione uma unidade para carregar.', 'warning');
                const mappedGiapUnits = unitMapping[unidade] || [unidade];
                if(mappedGiapUnits.length === 1 && mappedGiapUnits[0] === unidade && !unitMapping[unidade]) { showNotification('Esta unidade n√£o est√° mapeada. V√° para a aba "Ligar Unidades".', 'warning'); }
                document.getElementById('system-list-filter').value = ''; document.getElementById('giap-list-filter').value = ''; linksToCreate = []; renderCreatedLinks(); renderConciliationLists();
                clearGiapImportSelection(); document.getElementById('quick-actions').classList.remove('hidden'); selSys = selGiap = null;
            });

            const debouncedRenderConciliation = debounce(renderConciliationLists, 300);
            document.getElementById('system-list-filter').addEventListener('input', debouncedRenderConciliation); document.getElementById('giap-list-filter').addEventListener('input', debouncedRenderConciliation);
            document.getElementById('clear-selections').addEventListener('click', () => { selSys = selGiap = null; document.querySelectorAll('.reconciliation-list-item.selected').forEach(el => el.classList.remove('selected')); showNotification('Sele√ß√µes limpas.', 'info'); });
            
            document.getElementById('save-links').addEventListener('click', async () => {
                if (linksToCreate.length === 0) return showNotification('Nenhum novo link para salvar.', 'info');
                showOverlay(`Salvando ${linksToCreate.length} links...`);
                try {
                    await postData('performConciliation', { links: linksToCreate });
                    showNotification(`${linksToCreate.length} links salvos! A p√°gina ser√° recarregada.`, 'success');
                    setTimeout(() => { dataCache = null; loadData(true); }, 2000);
                } catch (error) { hideOverlay(); showNotification(`Erro: ${error.message}`, 'error'); }
            });

            document.getElementById('created-links').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-link-btn'); if (!deleteBtn) return;
                const index = parseInt(deleteBtn.dataset.index, 10); const removedLink = linksToCreate.splice(index, 1)[0];
                if (removedLink) {
                    const systemEl = document.querySelector(`#system-list div[data-id='${removedLink.systemItem.id}']`); if (systemEl) systemEl.classList.remove('linked');
                    const giapEl = document.querySelector(`#giap-list div[data-id='${removedLink.giapItem.TOMBAMENTO}']`); if (giapEl) giapEl.classList.remove('linked');
                } renderCreatedLinks(); showNotification('V√≠nculo removido.', 'info');
            });

            document.getElementById('import-giap-btn').addEventListener('click', async () => {
                if (giapItemsForImport.length === 0) return showNotification('Nenhum item GIAP selecionado para importar.', 'warning');
                const tipo = document.getElementById('filter-tipo').value; const unidade = document.getElementById('filter-unidade').value.trim();
                if (!unidade || !tipo) return showNotification('Selecione um Tipo e uma Unidade de destino nos filtros acima.', 'warning');
                const estado = document.getElementById('import-estado-select').value;
                showOverlay(`Importando ${giapItemsForImport.length} itens...`);
                try {
                    await postData('importGiapItems', { items: giapItemsForImport, tipo, unidade, estado });
                    showNotification(`${giapItemsForImport.length} itens importados! A p√°gina ser√° recarregada.`, 'success');
                    setTimeout(() => { dataCache = null; loadData(true); }, 2000);
                } catch (e) { hideOverlay(); showNotification(`Erro: ${e.message}`, 'error'); }
            });
            
            document.getElementById('suggest-sobrando').addEventListener('click', () => {
                const kw = normalizeStr(document.getElementById('leftover-keyword').value); const tfilter = document.getElementById('leftover-tombo').value.trim();
                const usedTombamentos = new Set(fullInventory.map(i => normalizeTombo(i.Tombamento)).filter(Boolean));
                const sob = giapInventory.filter(g => {
                    const tombo = normalizeTombo(g.TOMBAMENTO); if (!tombo || tombo.includes('permuta')) return false;
                    const giapDesc = normalizeStr(g.Descri√ß√£o || g.Esp√©cie || '');
                    return !usedTombamentos.has(tombo) && (!tfilter || tombo.includes(tfilter)) && (!kw || giapDesc.includes(kw));
                });
                document.getElementById('total-sobrando').textContent = sob.length; const list = document.getElementById('sobrando-list'); list.innerHTML = '';
                if (sob.length > 0) { sob.forEach(g => { const d = document.createElement('div'); d.className = 'card p-2 mb-1 text-sm'; d.textContent = `Tombo: ${g.TOMBAMENTO} - ${g.Descri√ß√£o || g.Esp√©cie} (Unidade GIAP: ${g.Unidade})`; list.append(d); });
                } else { list.innerHTML = `<p class="p-4 text-slate-500 text-center">Nenhum item encontrado com os filtros aplicados.</p>`; }
                showNotification(`${sob.length} tombos sobrando listados.`, 'success');
            });
            
            const subNavButtonsConciliar = document.querySelectorAll('#content-conciliar .sub-nav-btn');
            subNavButtonsConciliar.forEach(button => { button.addEventListener('click', (e) => { const subTab = e.currentTarget.dataset.subtabConciliar; subNavButtonsConciliar.forEach(btn => btn.classList.toggle('active', btn.dataset.subtabConciliar === subTab)); document.getElementById('subtab-conciliar-conciliacao_main').classList.toggle('hidden', subTab !== 'conciliacao_main'); document.getElementById('subtab-conciliar-itens_a_tombar').classList.toggle('hidden', subTab !== 'itens_a_tombar'); if(subTab === 'itens_a_tombar') { renderItensATombar(); } }); });

            const subNavButtonsImport = document.querySelectorAll('#content-importacao .sub-nav-btn');
            subNavButtonsImport.forEach(button => { button.addEventListener('click', (e) => { const subTab = e.currentTarget.dataset.subtab; subNavButtonsImport.forEach(btn => btn.classList.toggle('active', btn.dataset.subtab === subTab)); document.getElementById('subtab-content-substituir').classList.toggle('hidden', subTab !== 'substituir'); document.getElementById('subtab-content-edit-by-desc').classList.toggle('hidden', subTab !== 'edit-by-desc'); document.getElementById('subtab-content-massa').classList.toggle('hidden', subTab !== 'massa'); document.getElementById('subtab-content-add_giap').classList.toggle('hidden', subTab !== 'add_giap'); }); });
            
            document.getElementById('mass-transfer-search-btn').addEventListener('click', () => {
                const tombos = document.getElementById('mass-transfer-tombos').value.split(/[\s,]+/).map(t => t.trim()).filter(Boolean);
                const existingTombos = new Set(fullInventory.map(i => i.Tombamento?.trim()));
                const foundItems = []; const notFound = [];
                tombos.forEach(tombo => { const giapItem = giapMap.get(tombo); if (giapItem && !existingTombos.has(tombo)) foundItems.push(giapItem); else notFound.push(tombo); });
                if (notFound.length > 0) showNotification(`N√£o encontrados ou j√° existem: ${notFound.join(', ')}`, 'warning');
                const resultsEl = document.getElementById('mass-transfer-results');
                if (foundItems.length > 0) {
                    const listEl = document.getElementById('mass-transfer-list'); const estadoOptions = ['Novo', 'Bom', 'Regular', 'Avariado'];
                    listEl.innerHTML = foundItems.map(item => `<div class="p-2 border rounded-md bg-slate-50 grid grid-cols-3 gap-4 items-center"><div class="col-span-2"><strong>${escapeHtml(item.TOMBAMENTO)}</strong> - ${escapeHtml(item.Descri√ß√£o || item.Esp√©cie)}</div><div><select data-tombo="${escapeHtml(item.TOMBAMENTO)}" class="mass-transfer-status w-full p-1 border rounded bg-white">${estadoOptions.map(opt => `<option>${opt}</option>`).join('')}</select></div></div>`).join('');
                    resultsEl.classList.remove('hidden');
                } else { resultsEl.classList.add('hidden'); }
            });

            document.getElementById('mass-transfer-set-all-status').addEventListener('change', (e) => { document.querySelectorAll('.mass-transfer-status').forEach(select => select.value = e.target.value); });
            
            document.getElementById('mass-transfer-confirm-btn').addEventListener('click', async () => {
                const destinationUnit = document.getElementById('mass-transfer-unit').value; if (!destinationUnit) return showNotification('Selecione uma unidade de destino.', 'warning');
                const tipo = document.getElementById('mass-transfer-tipo').value;
                const itemsToCreate = Array.from(document.querySelectorAll('.mass-transfer-status')).map(select => ({ tombo: select.dataset.tombo, estado: select.value }));
                if (itemsToCreate.length === 0) return; showOverlay(`Criando ${itemsToCreate.length} itens...`);
                try {
                    await postData('massImportByTombamento', { items: itemsToCreate, unidade: destinationUnit, tipo });
                    showNotification(`${itemsToCreate.length} itens criados! Recarregando...`, 'success'); setTimeout(() => { dataCache = null; loadData(true); }, 1500);
                } catch (e) { hideOverlay(); showNotification(`Erro: ${e.message}`, 'error'); }
            });

            document.getElementById('preview-replace-btn').addEventListener('click', () => {
                 const data = document.getElementById('replace-data').value;
                const unit = document.getElementById('replace-unit').value;
                if (!unit) return showNotification('Selecione uma unidade de destino primeiro.', 'warning');
                if (!data) return showNotification('Cole os dados da planilha na √°rea de texto.', 'warning');

                Papa.parse(data, {
                    header: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        itemsToReplace = results.data.map(row => ({
                            UNIDADE_EXCEL: (row[0] || '').trim(),
                            ITEM: (row[1] || '').trim(),
                            TOMBO: (row[2] || '').trim(),
                            LOCAL: (row[3] || '').trim(),
                            ESTADO: (row[4] || '').trim()
                        }));
                        
                        const previewList = document.getElementById('replace-preview-list');
                        document.getElementById('replace-preview-count').textContent = itemsToReplace.length;
                        previewList.innerHTML = itemsToReplace.map(item => `
                            <div class="p-2 border-b text-xs">
                                <strong>${escapeHtml(item.ITEM)}</strong> (Tombo: ${escapeHtml(item.TOMBO) || 'S/T'})<br>
                                Local: ${escapeHtml(item.LOCAL)} | Estado: ${escapeHtml(item.ESTADO)}
                            </div>
                        `).join('');
                        document.getElementById('replace-results').classList.remove('hidden');
                    }
                });
            });

            document.getElementById('replace-confirm-checkbox').addEventListener('change', (e) => { document.getElementById('confirm-replace-btn').disabled = !e.target.checked; });
            
            document.getElementById('confirm-replace-btn').addEventListener('click', async () => {
                const tipo = document.getElementById('replace-tipo').value;
                const unidade = document.getElementById('replace-unit').value.trim();
                if (!unidade || itemsToReplace.length === 0) return showNotification('Dados inv√°lidos ou unidade n√£o selecionada.', 'error');
                showOverlay(`Substituindo invent√°rio de ${unidade}...`);
                try {
                    await postData('replaceInventory', { unidade, tipo, items: itemsToReplace });
                    showNotification(`Invent√°rio de ${unidade} substitu√≠do! Recarregando...`, 'success');
                    setTimeout(() => { dataCache = null; loadData(true); }, 2000);
                } catch(e) {
                    hideOverlay(); showNotification(`Erro: ${e.message}`, 'error');
                }
            });
            
            document.getElementById('save-giap-unit-btn').addEventListener('click', async () => {
                const newUnitName = document.getElementById('add-giap-name').value.trim();
                const newUnitNumber = document.getElementById('add-giap-number').value.trim();
                if (!newUnitName) return showNotification('O nome da unidade n√£o pode ser vazio.', 'warning');
                showOverlay('Salvando nova unidade...');
                try {
                    const updatedCustomUnits = await postData('addCustomGiapUnit', { name: newUnitName, number: newUnitNumber });
                    customGiapUnits = updatedCustomUnits;
                    showNotification('Nova unidade salva!', 'success');
                    document.getElementById('add-giap-name').value = '';
                    document.getElementById('add-giap-number').value = '';
                    updateGiapUnitOptions();
                } catch(e) {
                    showNotification(`Erro: ${e.message}`, 'error');
                } finally {
                    hideOverlay();
                }
            });

            document.getElementById('desc-choice-cancel-btn').addEventListener('click', () => { selSys = selGiap = null; document.querySelectorAll('.reconciliation-list-item.selected').forEach(el => el.classList.remove('selected')); closeDescriptionChoiceModal(); });
            document.getElementById('desc-choice-keep-btn').addEventListener('click', () => { addLinkToCreate(false); closeDescriptionChoiceModal(); });
            document.getElementById('desc-choice-update-btn').addEventListener('click', () => { addLinkToCreate(true); closeDescriptionChoiceModal(); });

            document.getElementById('tombar-filter-tipo').addEventListener('change', () => {
                 const tipo = document.getElementById('tombar-filter-tipo').value;
                const unidades = [...new Set(fullInventory.filter(i => i.etiquetaPendente === true && (!tipo || i.Tipo === tipo)).map(i => i.Unidade).filter(Boolean))].sort();
                const selU = document.getElementById('tombar-filter-unidade'); selU.innerHTML = '<option value="">Todas as Unidades</option>' + unidades.map(u => `<option>${u}</option>`).join('');
                selU.disabled = false; renderItensATombar();
            });
             document.getElementById('tombar-filter-unidade').addEventListener('change', renderItensATombar);
             document.getElementById('itens-a-tombar-container').addEventListener('click', async (e) => {
                const btn = e.target.closest('.confirmar-tombamento-btn'); if (!btn) return;
                const id = btn.dataset.id; btn.disabled = true; btn.textContent = 'Salvando...';
                try {
                    await postData('confirmTombamento', { id });
                    showNotification('Tombamento confirmado!', 'success'); 
                    const item = fullInventory.find(i => i.id === id);
                    if(item) item.etiquetaPendente = false;
                    renderItensATombar();
                } catch (error) { showNotification(`Erro: ${error.message}`, 'error'); btn.disabled = false; btn.textContent = 'Confirmar Tombamento'; }
             });

            document.getElementById('preview-edit-by-desc-btn').addEventListener('click', () => {
                // A l√≥gica de preview no lado do cliente permanece a mesma
                const unidade = document.getElementById('edit-by-desc-unit').value;
                const data = document.getElementById('edit-by-desc-data').value;
                if (!unidade) return showNotification('Selecione uma unidade de destino.', 'warning');
                if (!data) return showNotification('Cole os dados da planilha.', 'warning');

                Papa.parse(data, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (h) => {
                        const normH = normalizeStr(h);
                        if (normH.includes('item') || normH.includes('descri')) return 'descricao';
                        if (normH.includes('tombo') || normH.includes('tombamento')) return 'tombamento';
                        if (normH.includes('local')) return 'localizacao';
                        if (normH.includes('estado')) return 'estado';
                        return h;
                    },
                    complete: (results) => {
                        const pastedData = results.data;
                        const inventoryInUnit = fullInventory.filter(i => i.Unidade === unidade);
                        const existingTombos = new Map(fullInventory.map(i => [normalizeTombo(i.Tombamento), i]));

                        const availableItems = inventoryInUnit.map(item => ({ item, isMatched: false }));
                        
                        updatesToProcess = pastedData.map((row, rowIndex) => {
                            const pastedDesc = (row.descricao || '').trim();
                            const pastedTomboRaw = (row.tombamento || 'S/T').trim();
                            const pastedTombo = normalizeTombo(pastedTomboRaw);
                            const pastedLocal = (row.localizacao || '').trim();
                            const pastedEstado = parseEstadoEOrigem((row.estado || '').trim()).estado;

                            if (!pastedDesc) {
                                return { id: rowIndex, status: 'empty_row' };
                            }
                            
                            const potentialMatches = availableItems
                                .filter(wrapper => !wrapper.isMatched)
                                .map(wrapper => {
                                    const systemDesc = (wrapper.item.Descri√ß√£o || '').trim();
                                    const systemLocal = (wrapper.item.Localiza√ß√£o || '').trim();
                                    const systemEstado = (wrapper.item.Estado || '').trim();

                                    let score = calculateSimilarity(systemDesc, pastedDesc) * 100;
                                    if (systemDesc === pastedDesc) score += 50; 
                                    if (systemLocal === pastedLocal && pastedLocal) score += 15;
                                    if (systemEstado === pastedEstado) score += 10;
                                    
                                    return { wrapper, score };
                                })
                                .filter(match => match.score > 60) 
                                .sort((a, b) => b.score - a.score);

                            let bestMatchWrapper = null;
                            let matchType = 'not_found';
                            
                            if (potentialMatches.length > 0) {
                                bestMatchWrapper = potentialMatches[0].wrapper;
                                bestMatchWrapper.isMatched = true; 
                                
                                if (potentialMatches[0].score > 140) {
                                    matchType = 'exact';
                                } else if (potentialMatches.length > 1 && potentialMatches[0].score - potentialMatches[1].score < 10) {
                                    matchType = 'ambiguous';
                                } else {
                                    matchType = 'possible';
                                }
                            }
                            
                            const systemItem = bestMatchWrapper ? bestMatchWrapper.item : null;
                            const giapItem = pastedTombo ? giapMap.get(pastedTombo) : null;
                            const tomboInUse = pastedTombo && pastedTombo !== 'S/T' && existingTombos.has(pastedTombo) && existingTombos.get(pastedTombo).id !== systemItem?.id;
                            
                            let status = 'ok';
                            if (!systemItem) status = 'not_found';
                            else if (matchType === 'ambiguous') status = 'multiple_found';
                            else if (tomboInUse) status = 'tombo_in_use';

                            return {
                                id: rowIndex,
                                pastedData: { descricao: pastedDesc, tombamento: pastedTombo, localizacao: pastedLocal, estado: pastedEstado },
                                systemItem, giapItem, status, matchType, useGiapDesc: false,
                            };
                        }).filter(u => u.status !== 'empty_row');
                        
                        //renderEditByDescPreview(updatesToProcess); // Fun√ß√£o auxiliar para renderizar a tabela, n√£o inclu√≠da aqui para brevidade
                        document.getElementById('edit-by-desc-results').classList.remove('hidden');
                        document.getElementById('confirm-edit-by-desc-btn').disabled = updatesToProcess.filter(u => u.status === 'ok').length === 0;
                    }
                });
            });
            
            document.getElementById('edit-by-desc-preview-table-container').addEventListener('change', (e) => { 
                const checkbox = e.target;
                if (checkbox.classList.contains('use-giap-desc-cb')) {
                    const updateId = parseInt(checkbox.dataset.updateId, 10);
                    const update = updatesToProcess.find(u => u.id === updateId);
                    if (update) {
                        update.useGiapDesc = checkbox.checked;
                    }
                }
            });
            
            document.getElementById('confirm-edit-by-desc-btn').addEventListener('click', async () => {
                const validUpdates = updatesToProcess.filter(u => u.status === 'ok');
                if(validUpdates.length === 0) return showNotification('Nenhum item v√°lido para atualizar.', 'error');
                showOverlay(`Atualizando ${validUpdates.length} itens...`);
                try {
                    await postData('updateByDescription', { updates: validUpdates });
                    showNotification(`${validUpdates.length} itens atualizados! Recarregando...`, 'success');
                    setTimeout(() => { dataCache = null; loadData(true); }, 2000);
                } catch(e) {
                    hideOverlay(); showNotification(`Erro: ${e.message}`, 'error');
                }
            });

            const debouncedRenderNf = debounce(renderNfList, 300);
            document.getElementById('nf-search').addEventListener('input', debouncedRenderNf);
            document.getElementById('nf-item-search').addEventListener('input', debouncedRenderNf);
            document.getElementById('nf-tipo-entrada').addEventListener('change', renderNfList);
            document.getElementById('nf-date-start').addEventListener('change', renderNfList);
            document.getElementById('nf-date-end').addEventListener('change', renderNfList);
            document.getElementById('clear-nf-filters-btn').addEventListener('click', () => {
                document.getElementById('nf-search').value = ''; document.getElementById('nf-item-search').value = ''; document.getElementById('nf-tipo-entrada').value = '';
                document.getElementById('nf-date-start').value = ''; document.getElementById('nf-date-end').value = ''; renderNfList();
            });
        });
    </script>
</body>
</html>

